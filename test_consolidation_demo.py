#!/usr/bin/env python3
"""
üîó DEMO KONSOLIDACJI KLASTR√ìW - Test Nowego Systemu Post-Processing
Demonstracja jak nowy system konsolidacji radzi sobie z problemem over-segmentation

Symuluje dane podobne do tych kt√≥re u≈ºytkownik ma (37 ma≈Çych grup ‚Üí 8-12 du≈ºych grup)
"""

import asyncio
import os
from app.services.semantic_clustering import SemanticClusteringService, enable_clustering_consolidation
from app.services.semantic_clustering import ClusterConsolidator

# Dane testowe na podstawie rzeczywistych wynik√≥w u≈ºytkownika
SAMPLE_CLUSTER_RESULTS = [
    {
        "group_label": "Grupa: ile kosztujƒÖ soczewki roczne na astygmatyzm, ile kosztujƒÖ soczewki dzienne, ile kosztujƒÖ soczewki jednodniowe",
        "phrases_count": 7,
        "avg_similarity": 0.834,
        "members": [
            {"phrase": "ile kosztujƒÖ soczewki astygmatyzm", "similarity_score": 0.89},
            {"phrase": "ile kosztujƒÖ soczewki dzienne", "similarity_score": 0.87},
            {"phrase": "ile kosztujƒÖ soczewki jednodniowe", "similarity_score": 0.85},
            {"phrase": "ile kosztujƒÖ soczewki kontaktowe", "similarity_score": 0.83},
            {"phrase": "ile kosztujƒÖ soczewki miesiƒôczne", "similarity_score": 0.82},
            {"phrase": "ile kosztujƒÖ soczewki na wadƒô wzroku", "similarity_score": 0.81},
            {"phrase": "ile kosztujƒÖ soczewki roczne", "similarity_score": 0.80}
        ]
    },
    {
        "group_label": "Grupa: ile kosztujƒÖ soczewki progresywne biofinity, ile kosztujƒÖ soczewki toryczne",
        "phrases_count": 2,
        "avg_similarity": 0.712,
        "members": [
            {"phrase": "ile kosztujƒÖ soczewki progresywne biofinity", "similarity_score": 0.72},
            {"phrase": "ile kosztujƒÖ soczewki toryczne", "similarity_score": 0.70}
        ]
    },
    {
        "group_label": "Grupa: tanie soczewki miesiƒôczne toryczne, tanie soczewki na astygmatyzm",
        "phrases_count": 5,
        "avg_similarity": 0.698,
        "members": [
            {"phrase": "tanie soczewki miesiƒôczne toryczne", "similarity_score": 0.75},
            {"phrase": "tanie soczewki na astygmatyzm", "similarity_score": 0.73},
            {"phrase": "tanie soczewki kontaktowe", "similarity_score": 0.71},
            {"phrase": "najta≈Ñsze soczewki kontaktowe", "similarity_score": 0.68},
            {"phrase": "promocje na soczewki", "similarity_score": 0.65}
        ]
    },
    {
        "group_label": "Grupa: soczewki acuvue oasys for astigmatism, soczewki acuvue, soczewki acuvue oasys",
        "phrases_count": 4,
        "avg_similarity": 0.834,
        "members": [
            {"phrase": "acuvue oasys soczewki", "similarity_score": 0.87},
            {"phrase": "acuvue soczewki", "similarity_score": 0.85},
            {"phrase": "soczewki acuvue", "similarity_score": 0.83},
            {"phrase": "soczewki acuvue oasys", "similarity_score": 0.81}
        ]
    },
    {
        "group_label": "Grupa: soczewki oasys, acuvue oasys cena",
        "phrases_count": 2,
        "avg_similarity": 0.723,
        "members": [
            {"phrase": "soczewki oasys", "similarity_score": 0.74},
            {"phrase": "acuvue oasys cena", "similarity_score": 0.71}
        ]
    },
    {
        "group_label": "Grupa: biofinity multifocal soczewki, biofinity szt 6",
        "phrases_count": 3,
        "avg_similarity": 0.687,
        "members": [
            {"phrase": "biofinity multifocal soczewki", "similarity_score": 0.72},
            {"phrase": "biofinity szt 6", "similarity_score": 0.68},
            {"phrase": "biofinity soczewki", "similarity_score": 0.65}
        ]
    },
    {
        "group_label": "Grupa: soczewki jednodniowe dailies total 1",
        "phrases_count": 2,
        "avg_similarity": 0.745,
        "members": [
            {"phrase": "soczewki jednodniowe dailies total 1", "similarity_score": 0.75},
            {"phrase": "dailies total 1 soczewki", "similarity_score": 0.74}
        ]
    },
    {
        "group_label": "Grupa: soczewki miesiƒôczne biofinity, biofinity",
        "phrases_count": 3,
        "avg_similarity": 0.623,
        "members": [
            {"phrase": "soczewki miesiƒôczne biofinity", "similarity_score": 0.68},
            {"phrase": "biofinity", "similarity_score": 0.62},
            {"phrase": "soczewki biofinity", "similarity_score": 0.58}
        ]
    },
    {
        "group_label": "Grupa: alensa pl soczewki kontaktowe, alensa soczewki, alensa",
        "phrases_count": 5,
        "avg_similarity": 0.712,
        "members": [
            {"phrase": "alensa pl soczewki kontaktowe", "similarity_score": 0.76},
            {"phrase": "alensa soczewki", "similarity_score": 0.74},
            {"phrase": "alensa", "similarity_score": 0.71},
            {"phrase": "alensa pl", "similarity_score": 0.69},
            {"phrase": "sklep alensa", "similarity_score": 0.67}
        ]
    },
    {
        "group_label": "Grupa: Meta Quest 3, quest 3",
        "phrases_count": 2,
        "avg_similarity": 0.892,
        "members": [
            {"phrase": "Meta Quest 3", "similarity_score": 0.90},
            {"phrase": "quest 3", "similarity_score": 0.88}
        ]
    },
    {
        "group_label": "Grupa: jak za≈Ço≈ºyƒá soczewki kontaktowe",
        "phrases_count": 1,
        "avg_similarity": 0.000,
        "members": [
            {"phrase": "jak za≈Ço≈ºyƒá soczewki kontaktowe", "similarity_score": 1.0}
        ]
    },
    {
        "group_label": "Grupa: soczewki kontaktowe jednodniowe",
        "phrases_count": 2,
        "avg_similarity": 0.834,
        "members": [
            {"phrase": "soczewki kontaktowe jednodniowe", "similarity_score": 0.86},
            {"phrase": "jednodniowe soczewki kontaktowe", "similarity_score": 0.81}
        ]
    }
]

async def test_consolidation_system():
    """üß™ Test systemu konsolidacji na przyk≈Çadowych danych"""
    
    print("üîó TEST SYSTEMU KONSOLIDACJI POST-PROCESSING")
    print("=" * 60)
    
    # Symuluj stan przed konsolidacjƒÖ
    print(f"üìä PRZED KONSOLIDACJƒÑ:")
    print(f"   ‚Ä¢ Liczba grup: {len(SAMPLE_CLUSTER_RESULTS)}")
    
    total_phrases = sum(cluster['phrases_count'] for cluster in SAMPLE_CLUSTER_RESULTS)
    print(f"   ‚Ä¢ Ca≈Çkowita liczba fraz: {total_phrases}")
    
    # Poka≈º problemy
    small_groups = [c for c in SAMPLE_CLUSTER_RESULTS if c['phrases_count'] <= 2]
    print(f"   ‚Ä¢ Ma≈Çe grupy (‚â§2 frazy): {len(small_groups)}")
    
    print(f"\nüîç PRZYK≈ÅADY PROBLEM√ìW:")
    
    # Problem 1: Duplikacja koszt√≥w
    cost_groups = [c for c in SAMPLE_CLUSTER_RESULTS if any(word in c['group_label'].lower() for word in ['ile kosztujƒÖ', 'tanie', 'cena'])]
    print(f"   ‚Ä¢ Grupy o kosztach (powinny byƒá po≈ÇƒÖczone): {len(cost_groups)}")
    for group in cost_groups[:3]:
        print(f"     - {group['group_label'][:60]}... ({group['phrases_count']} fraz)")
    
    # Problem 2: Duplikacja Acuvue 
    acuvue_groups = [c for c in SAMPLE_CLUSTER_RESULTS if 'acuvue' in c['group_label'].lower()]
    print(f"   ‚Ä¢ Grupy Acuvue (powinny byƒá po≈ÇƒÖczone): {len(acuvue_groups)}")
    for group in acuvue_groups:
        print(f"     - {group['group_label'][:60]}... ({group['phrases_count']} fraz)")
    
    # Problem 3: Outliers
    outlier_groups = [c for c in SAMPLE_CLUSTER_RESULTS if any(word in c['group_label'].lower() for word in ['meta quest', 'quest 3'])]
    if outlier_groups:
        print(f"   ‚Ä¢ Outliers (powinny byƒá usuniƒôte): {len(outlier_groups)}")
        for group in outlier_groups:
            print(f"     - {group['group_label']} ({group['phrases_count']} fraz)")
    
    print("\n" + "=" * 60)
    print("üîó ZASTOSOWANIE KONSOLIDACJI")
    print("=" * 60)
    
    # Utw√≥rz konsolidator i zastosuj
    consolidator = ClusterConsolidator("soczewki kontaktowe")
    consolidated_results = consolidator.consolidate_clusters(SAMPLE_CLUSTER_RESULTS)
    
    print(f"\nüìä PO KONSOLIDACJI:")
    print(f"   ‚Ä¢ Liczba grup: {len(consolidated_results)}")
    
    consolidated_phrases = sum(cluster['phrases_count'] for cluster in consolidated_results)
    print(f"   ‚Ä¢ Ca≈Çkowita liczba fraz: {consolidated_phrases}")
    
    reduction_percent = ((len(SAMPLE_CLUSTER_RESULTS) - len(consolidated_results)) / len(SAMPLE_CLUSTER_RESULTS)) * 100
    print(f"   ‚Ä¢ Redukcja grup: {reduction_percent:.1f}%")
    
    print(f"\nüèÜ SKONSOLIDOWANE GRUPY:")
    consolidated_results.sort(key=lambda x: x['phrases_count'], reverse=True)
    
    for i, group in enumerate(consolidated_results, 1):
        group_name = group['group_label']
        phrase_count = group['phrases_count']
        
        # Poka≈º kilka przyk≈Çadowych fraz
        sample_phrases = [m['phrase'] for m in group['members'][:3]]
        sample_text = ", ".join(sample_phrases)
        if len(sample_text) > 80:
            sample_text = sample_text[:77] + "..."
        
        consolidation_marker = "üîó" if group.get('consolidated') else ""
        print(f"   {i:2d}. {group_name} {consolidation_marker}")
        print(f"       ‚îî‚îÄ {phrase_count} fraz: {sample_text}")
    
    print(f"\n‚úÖ REZULTATY:")
    print(f"   ‚Ä¢ Znacznie mniej grup: {len(SAMPLE_CLUSTER_RESULTS)} ‚Üí {len(consolidated_results)}")
    print(f"   ‚Ä¢ Wiƒôksze, bardziej sensowne grupy")
    print(f"   ‚Ä¢ Logiczne nazwy grup (Ceny i koszty, Marki - Acuvue, itp.)")
    print(f"   ‚Ä¢ Outliers usuniƒôte lub przeniesione")
    
    # Sprawd≈∫ czy g≈Ç√≥wne problemy zosta≈Çy rozwiƒÖzane
    print(f"\nüîç WERYFIKACJA ROZWIƒÑZANIA:")
    
    # Sprawd≈∫ konsolidacjƒô koszt√≥w
    cost_groups_after = [c for c in consolidated_results if 'ceny' in c['group_label'].lower() or 'kosz' in c['group_label'].lower()]
    if cost_groups_after:
        print(f"   ‚úÖ Grupy koszt√≥w skonsolidowane: {len(cost_groups)} ‚Üí {len(cost_groups_after)}")
        cost_group = cost_groups_after[0]
        print(f"      ‚îî‚îÄ '{cost_group['group_label']}' ({cost_group['phrases_count']} fraz)")
    
    # Sprawd≈∫ konsolidacjƒô Acuvue
    acuvue_groups_after = [c for c in consolidated_results if 'acuvue' in c['group_label'].lower()]
    if acuvue_groups_after:
        print(f"   ‚úÖ Grupy Acuvue skonsolidowane: {len(acuvue_groups)} ‚Üí {len(acuvue_groups_after)}")
        acuvue_group = acuvue_groups_after[0]
        print(f"      ‚îî‚îÄ '{acuvue_group['group_label']}' ({acuvue_group['phrases_count']} fraz)")
    
    # Sprawd≈∫ usuniƒôcie outliers
    outliers_after = [c for c in consolidated_results if any(word in c['group_label'].lower() for word in ['meta quest', 'quest'])]
    if not outliers_after:
        print(f"   ‚úÖ Outliers usuniƒôte: {len(outlier_groups)} grup Meta Quest")
    
    return consolidated_results

async def demo_integration_with_service():
    """üîó Demo integracji z SemanticClusteringService"""
    
    print("\n" + "=" * 60)
    print("üîß DEMO INTEGRACJI Z SERWISEM")
    print("=" * 60)
    
    print("üìù Kod do integracji z Twoim systemem:")
    print("""
# 1. Import funkcji pomocniczej
from app.services.semantic_clustering import enable_clustering_consolidation

# 2. W≈ÇƒÖczenie konsolidacji dla instancji serwisu
service = SemanticClusteringService(supabase_client)
enable_clustering_consolidation(service)  # ‚Üê W≈ÇƒÖcza konsolidacjƒô

# 3. Pobieranie wynik√≥w - automatycznie skonsolidowane
results = await service.get_clustering_results(seed_keyword_id)

# 4. Sprawdzenie czy konsolidacja zosta≈Ça zastosowana
if results and results.get('consolidation_applied'):
    print(f"‚úÖ Konsolidacja zastosowana: {len(results['groups'])} grup")
    
    # Ka≈ºda grupa ma flagƒô post_processed = True
    for group in results['groups']:
        if group.get('post_processed'):
            print(f"üîó Grupa skonsolidowana: {group['group_label']}")
else:
    print("‚ÑπÔ∏è Konsolidacja wy≈ÇƒÖczona")
""")
    
    print("üéØ PRZEWIDYWANE REZULTATY dla Twoich danych:")
    print("   ‚Ä¢ 37 grup ‚Üí 8-12 grup")
    print("   ‚Ä¢ Wszystkie grupy o kosztach po≈ÇƒÖczone w 'Ceny i koszty'")
    print("   ‚Ä¢ Wszystkie produkty Acuvue w 'Marki - Acuvue'")
    print("   ‚Ä¢ Outliers jak 'Meta Quest 3' usuniƒôte")
    print("   ‚Ä¢ Wiƒôksze grupy po 8-15 fraz ka≈ºda")
    print("   ‚Ä¢ ‚â§5% fraz w grupie 'R√≥≈ºne' (zamiast 47% niesklasyfikowanych)")

if __name__ == "__main__":
    print("üöÄ ROZPOCZYNAM DEMO KONSOLIDACJI...")
    asyncio.run(test_consolidation_system())
    asyncio.run(demo_integration_with_service())
    print("\nüéâ DEMO ZAKO≈ÉCZONE - system gotowy do u≈ºycia!") 