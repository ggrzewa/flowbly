<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Analysis Mission Control — Start Analysis</title>
    <style>
        /* ====== NASA MISSION CONTROL — START SCREEN ====== */
        :root{
          --bg:#f7f8fa; --panel:#fff; --panel-2:#f0f2f5; --text:#222; --muted:#6c757d;
          --blue:#0b3d91; --blue-2:#1560bd; --green:#198754; --red:#dc3545; --orange:#fd7e14; --purple:#6f42c1; --cyan:#17a2b8;
          --pink:#e91e63; --teal:#20c997; --indigo:#6610f2; --yellow:#ffc107; --lime:#32cd32;
          --border:#e5e7eb; --shadow:0 2px 8px rgba(0,0,0,.06); --glow:0 0 0 3px rgba(21,96,189,.18);
          --gap:10px; --pad:12px; --radius:8px;
        }
        *{box-sizing:border-box}
        body{margin:0;background:linear-gradient(135deg,#f7f8fa 0%,#eceff3 100%);color:var(--text);
             font:12px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;
             min-height:100vh;display:flex;flex-direction:column}

        /* ===== Header ===== */
        .mission-header{
          background:linear-gradient(90deg,var(--blue),var(--indigo));
          color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between;
          box-shadow:var(--shadow)
        }
        .mission-title{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.6px;text-transform:uppercase;font-size:13px}
        .status-ind{width:10px;height:10px;border-radius:50%;background:var(--lime);box-shadow:0 0 10px var(--lime);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
        .mission-time{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
          font-size:11px;background:rgba(255,255,255,.15);padding:4px 8px;border-radius:4px;border:1px solid rgba(255,255,255,.2)}

        /* ===== Main Container ===== */
        .control-room{max-width:800px;margin:60px auto;padding:20px;flex:1;display:flex;align-items:center;justify-content:center}

        /* ===== Start Panel ===== */
        .start-panel{background:#fff;border:2px solid var(--blue);padding:32px;width:100%;
          box-shadow:0 4px 20px rgba(0,0,0,.1)}
        .panel-header{text-align:center;margin-bottom:32px}
        .panel-icon{font-size:48px;margin-bottom:12px}
        .panel-title{font-size:22px;font-weight:800;color:var(--blue);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
        .panel-subtitle{font-size:12px;color:var(--muted);font-weight:500}

        /* ===== Form ===== */
        .form-group{margin-bottom:24px}
        .form-label{font-size:11px;font-weight:800;color:var(--text);text-transform:uppercase;
          letter-spacing:.5px;margin-bottom:8px;display:block}
        .form-input{width:100%;padding:12px 16px;border:2px solid var(--border);font-size:14px;
          font-family:inherit;transition:all .2s ease;background:#fff}
        .form-input:focus{outline:none;border-color:var(--blue);box-shadow:var(--glow)}
        .form-input:hover{border-color:#cbd5e1}

        .form-select{width:100%;padding:12px 16px;border:2px solid var(--border);font-size:14px;
          font-family:inherit;background:#fff;cursor:pointer;transition:all .2s ease;
          appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
          background-repeat:no-repeat;background-position:right 12px center}
        .form-select:focus{outline:none;border-color:var(--blue);box-shadow:var(--glow)}
        .form-select:hover{border-color:#cbd5e1}

        /* ===== Button ===== */
        .btn-launch{width:100%;padding:18px 24px;
          background:linear-gradient(135deg,#10b981 0%,#059669 100%);
          color:#fff;border:none;border-radius:12px;
          font-size:14px;font-weight:700;letter-spacing:.3px;
          cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);
          display:flex;align-items:center;justify-content:center;gap:10px;
          box-shadow:0 4px 14px 0 rgba(16,185,129,.2);position:relative;overflow:hidden}
        .btn-launch::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
          background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
          transition:left .5s ease}
        .btn-launch:hover::before{left:100%}
        .btn-launch:hover{transform:translateY(-3px);box-shadow:0 12px 28px 0 rgba(16,185,129,.35);
          background:linear-gradient(135deg,#059669 0%,#047857 100%)}
        .btn-launch:active{transform:translateY(-1px);box-shadow:0 6px 18px 0 rgba(16,185,129,.25)}
        .btn-launch:disabled{background:linear-gradient(135deg,#9ca3af 0%,#6b7280 100%);
          cursor:not-allowed;transform:none;box-shadow:0 2px 8px 0 rgba(156,163,175,.2)}
        .btn-icon{font-size:18px;transition:transform .3s ease}
        .btn-launch:hover .btn-icon{transform:translateX(4px) rotate(15deg)}

        /* ===== Success Message ===== */
        .success-message-new{background:#d4edda;border:2px solid var(--green);border-left:6px solid var(--green);
          padding:16px;margin-top:24px;display:none;align-items:center;gap:12px}
        .success-message-new.show{display:flex}
        .success-icon{font-size:24px}
        .success-text{font-size:13px;font-weight:700;color:#155724}

        /* ===== Info Panel ===== */
        .info-panel{background:var(--panel-2);border-left:3px solid var(--blue);padding:14px;margin-top:24px}
        .info-title{font-size:10px;font-weight:800;color:var(--blue);text-transform:uppercase;
          letter-spacing:.5px;margin-bottom:6px}
        .info-text{font-size:11px;color:var(--text);line-height:1.6}

        /* ===== System Status ===== */
        .system-status{display:flex;gap:8px;margin-top:24px;padding-top:20px;border-top:1px solid var(--border)}
        .status-item{flex:1;text-align:center}
        .status-label{font-size:9px;color:var(--muted);font-weight:700;text-transform:uppercase;margin-bottom:4px}
        .status-value{font-size:11px;font-weight:800;color:var(--text);font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
        .status-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;background:var(--green)}

        /* ===== Loading State ===== */
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        .spinner-new{display:inline-block;animation:spin 1s linear infinite}

        /* ===== Responsive ===== */
        @media (max-width: 768px){
          .control-room{margin:20px auto;padding:16px}
          .start-panel{padding:24px}
          .panel-title{font-size:18px}
        }
        
        /* ===== Legacy CSS (dla pozostałych sekcji) ===== */
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            font-weight: bold;
            color: #555;
        }
        
        .steps-list {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .step-item {
            padding: 8px;
            margin: 3px 0;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .step-item.success {
            background: #d4edda;
            color: #155724;
        }
        
        .step-item.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .step-item.timeout {
            background: #fff3cd;
            color: #856404;
        }
        
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        /* Results Container */
        .results-container {
            margin-top: 30px;
            display: none;
        }
        
        .section-container {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .loading-section {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-section .spinner {
            font-size: 48px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .module-status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .module-status.loaded {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .module-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        /* Clustering specific styles */
        .clustering-header {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .clustering-button {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }
        
        .clustering-button:hover {
            background: linear-gradient(135deg, #7d3c98, #8e44ad);
            transform: translateY(-2px);
        }
        
        .clustering-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .clustering-progress {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            display: none;
        }
        
        .clustering-progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .clustering-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8e44ad, #9b59b6);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* NASA Mission Control - Clustering Results */
        .clustering-results {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0;
            margin: 15px 0;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,.06);
        }
        
        .clustering-summary {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 16px;
        }
        
        .clustering-summary h3 {
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .clustering-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 900;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
        }
        
        .cluster-groups-container {
            padding: 20px;
        }
        
        .cluster-group {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin: 0 0 16px 0;
            padding: 0;
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .cluster-group:hover {
            border-color: #9b59b6;
            box-shadow: 0 4px 12px rgba(142,68,173,0.15);
            transform: translateY(-2px);
        }
        
        .cluster-group-header {
            background: linear-gradient(135deg, #e7f3ff 0%, #cce7ff 100%);
            border-bottom: 2px solid #0b3d91;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .cluster-group-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .cluster-group-number {
            background: #0b3d91;
            color: white;
            font-weight: 800;
            font-size: 14px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .cluster-group h4 {
            margin: 0;
            color: #0b3d91;
            font-size: 15px;
            font-weight: 800;
            flex: 1;
        }
        
        .cluster-group-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: #6c757d;
            font-weight: 600;
        }
        
        .cluster-group-meta span {
            background: rgba(11,61,145,0.1);
            padding: 4px 10px;
            border-radius: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
        }
        
        .cluster-phrases-container {
            padding: 18px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .cluster-phrase {
            display: inline-block;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            color: #155724;
            padding: 6px 12px;
            margin: 0;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #c3e6cb;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .cluster-phrase:hover {
            background: linear-gradient(135deg, #155724 0%, #1e7e34 100%);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(21,87,36,0.3);
        }
        
        .cluster-phrase.representative {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: white;
            font-weight: 800;
            border: 2px solid #7d3c98;
            padding: 7px 14px;
        }
        
        .cluster-phrase.representative::before {
            content: '⭐ ';
        }
        
        .cluster-phrase.representative:hover {
            background: linear-gradient(135deg, #6c3483 0%, #8e44ad 100%);
            transform: scale(1.08);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="mission-header">
        <div class="mission-title">
            <span class="status-ind"></span> 
            SEO ANALYSIS MISSION CONTROL
        </div>
        <div id="clock" class="mission-time">0000-00-00 00:00:00 MET</div>
    </div>

    <main class="control-room">
        <div class="start-panel">
            
            <!-- Panel Header -->
            <div class="panel-header">
                <div class="panel-icon">🔍</div>
                <h1 class="panel-title">SEO Analysis Tool</h1>
                <p class="panel-subtitle">Modular Version — Comprehensive Keyword Analysis System</p>
            </div>

            <!-- Analysis Form -->
            <form id="keywordForm">
                
                <!-- Keyword Input -->
                <div class="form-group">
                    <label class="form-label" for="keyword">Słowo kluczowe:</label>
                    <input 
                        type="text" 
                        id="keyword" 
                        name="keyword"
                        class="form-input" 
                        placeholder="np. okna, ubezpieczenia, zegarki..."
                        required
                    />
                </div>

                <!-- Country/Language Select -->
                <div class="form-group">
                    <label class="form-label" for="country">Kraj i język:</label>
                    <select id="country" name="country" class="form-select" required>
                        <option value="">Wybierz kraj...</option>
                    </select>
                </div>

                <!-- Launch Button -->
                <button type="submit" class="btn-launch" id="submitBtn">
                    <span class="btn-icon">🚀</span>
                    <span>Uruchom analizę</span>
                </button>

                <!-- Success Message (hidden by default) -->
                <div class="success-message-new" id="successMessageNew">
                    <span class="success-icon">✅</span>
                    <span class="success-text">Analiza zakończona pomyślnie!</span>
                </div>

            </form>

            <!-- Info Panel -->
            <div class="info-panel">
                <div class="info-title">System Information</div>
                <div class="info-text">
                    Ten system przeprowadzi kompleksową analizę SEO obejmującą 10 modułów: Extended Header, 
                    Core SEO Metrics, Intent Analysis, Demographics, Trends & Seasonality, Geographic Data, 
                    Competition Analysis, Related Keywords, SERP Analysis oraz Autocomplete Analysis.
                </div>
            </div>

            <!-- System Status -->
            <div class="system-status">
                <div class="status-item">
                    <div class="status-label">API Status</div>
                    <div class="status-value">
                        <span class="status-dot"></span>
                        ONLINE
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Database</div>
                    <div class="status-value">
                        <span class="status-dot"></span>
                        READY
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Modules</div>
                    <div class="status-value">
                        <span class="status-dot"></span>
                        10/10
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <!-- Legacy containers (hidden initially, shown when analysis runs) -->
    <div class="container" style="display: none;" id="legacyContainer">
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Rozpoczynanie analizy...</div>
            <div class="steps-list" id="stepsList"></div>
        </div>
        
        <div class="message" id="messageContainer"></div>
        
        <!-- Export Section -->
        <div id="exportSection" style="display: none; margin-top: 30px;">
            <div style="background: #e8f5e8; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px;">
                <h3 style="margin-top: 0; color: #155724;">📦 Eksport danych analizy</h3>
                <p style="margin-bottom: 15px; color: #155724;">
                    Zapisz kompletne dane ze wszystkich 10 sekcji analizy w wybranym formacie:
                </p>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button type="button" id="exportJsonBtn" style="flex: 1; min-width: 200px; background: #28a745; padding: 15px;">
                        📄 Eksportuj do JSON
                    </button>
                    <button type="button" id="exportHtmlBtn" style="flex: 1; min-width: 200px; background: #17a2b8; padding: 15px;">
                        📋 Eksportuj do HTML
                    </button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                    <strong>Eksportowane dane obejmują:</strong>
                    Wszystkie sekcje (1-10), powiązane słowa kluczowe, wyniki SERP, 
                    sugestie autocomplete, dane historyczne, demografię i więcej.
                </div>
            </div>
        </div>
        
        <!-- Module Status -->
        <div id="moduleStatus" style="display: none;">
            <h3>📦 Status Modułów</h3>
            <div id="moduleStatusList"></div>
        </div>
    </div>
    
    <!-- Results Container -->
    <div class="results-container" id="resultsContainer">
        <!-- SEKCJA 1: EXTENDED HEADER -->
        <div class="section-container">
            <div class="section-header">
                <h2>🎯 SEKCJA 1: EXTENDED HEADER</h2>
            </div>
            <div id="keywordHeader" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- SEKCJA 2: EXTENDED CORE SEO METRICS -->
        <div class="section-container">
            <div class="section-header">
                <h2>📊 SECTION 2: CORE KEYWORD METRICS</h2>
            </div>
            <div id="seoMetrics" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- SECTION 3: SEARCH INTENT -->
        <div class="section-container">
            <div class="section-header">
                <h2>🧠 SECTION 3: SEARCH INTENT</h2>
            </div>
            <div id="intentAnalysis" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- SECTION 4: AUDIENCE DEMOGRAPHICS -->
        <div class="section-container">
            <div class="section-header">
                <h2>👥 SECTION 4: AUDIENCE DEMOGRAPHICS</h2>
            </div>
            <div id="demographicsAnalysis" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- SECTION 5: SEARCH TRENDS -->
        <div class="section-container">
            <div class="section-header">
                <h2>📈 SECTION 5: SEARCH TRENDS</h2>
            </div>
            <div id="trendsAnalysis" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- SECTION 6: GEOGRAPHIC INTEREST -->
        <div class="section-container">
            <div class="section-header">
                <h2>🌍 SECTION 6: GEOGRAPHIC INTEREST</h2>
            </div>
            <div id="geographicAnalysis" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- SECTION 7 HIDDEN: Competition Analysis not displayed by request -->
        
        <!-- SECTION 8: RELATED KEYWORDS -->
        <div class="section-container">
            <div class="section-header">
                <h2>🔗 SECTION 8: RELATED KEYWORDS</h2>
            </div>
            <div style="padding:10px 0;color:#0b3d91;font-size:12px;line-height:1.5">
                Discover what else people search for related to your keyword. Use these insights to expand your content strategy, find new topic opportunities, and understand user search behavior.
            </div>
            <div id="relatedKeywordsAnalysis" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- SECTION 9: SERP ANALYSIS -->
        <div class="section-container">
            <div class="section-header">
                <h2>🔍 SECTION 9: SERP ANALYSIS</h2>
            </div>
            <div style="padding:10px 0;color:#0b3d91;font-size:12px;line-height:1.5">
                Analyze actual Google search results for this keyword. See what types of content rank, identify SERP features, and discover content opportunities from People Also Ask and Related Searches.
            </div>
            <div id="serpAnalysis" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- SECTION 10: AUTOCOMPLETE SUGGESTIONS -->
        <div class="section-container">
            <div class="section-header">
                <h2>🔮 SECTION 10: AUTOCOMPLETE SUGGESTIONS</h2>
            </div>
            <div style="padding:10px 0;color:#0b3d91;font-size:12px;line-height:1.5">
                Google autocomplete suggestions for this keyword. These represent common searches people make and can reveal user intent and content opportunities.
            </div>
            <div id="autocompleteAnalysis" class="loading-section">
                <div class="spinner">🔄</div>
                <p>Ładowanie modułu sekcji...</p>
            </div>
        </div>
        
        <!-- MODULE 1: SEMANTIC KEYWORD CLUSTERING -->
        <div class="section-container" id="clusteringSection" style="display: none;">
            <div class="clustering-header">
                <h2>🧠 MODULE 1: SEMANTIC KEYWORD CLUSTERING</h2>
            </div>
            <div id="semanticClustering">
                <div style="text-align: center; padding: 20px;">
                    <p style="margin-bottom: 20px; font-size: 16px; color: #666; max-width:900px; margin-left:auto; margin-right:auto;">
                        Group related keywords by semantic meaning and search intent. Semantic clustering helps you understand topic relationships, organize content strategy, and discover natural content pillars for your website. Instead of manually sorting hundreds of keywords, AI automatically identifies meaningful groups based on how similar keywords are in meaning.
                    </p>
                    
                    <div style="margin-bottom: 15px;">
                        <button type="button" id="testOpenAIBtn" class="clustering-button" style="background-color: #17a2b8; margin-right: 10px;">
                            🧪 Test API Connection
                        </button>
                        <button type="button" id="clusteringBtn" class="clustering-button">
                            🚀 Run Semantic Clustering
                        </button>
                    </div>
                    
                    <div id="clusteringProgress" class="clustering-progress">
                        <div class="clustering-progress-bar">
                            <div id="clusteringProgressFill" class="clustering-progress-fill"></div>
                        </div>
                        <div id="clusteringProgressText" style="text-align: center; font-weight: bold; color: #666;">
                            Preparing clustering...
                        </div>
                        <div id="clusteringSteps" style="margin-top: 15px; font-size: 14px; color: #666;"></div>
                    </div>
                    
                    <div id="clusteringResults" class="clustering-results">
                        <!-- Wyniki klastrowania będą tutaj -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODULE 3: SITE ARCHITECTURE GENERATOR -->
        <div class="section-container" id="architectureSection" style="display: none;">
            <div style="background: linear-gradient(135deg, #e67e22, #d35400); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h2>🏗️ MODULE 3: SITE ARCHITECTURE GENERATOR</h2>
            </div>
            <div id="architectureGenerator">
                <div style="text-align: center; padding: 20px;">
                    <p style="margin-bottom: 20px; font-size: 16px; color: #666; max-width:900px; margin-left:auto; margin-right:auto;">
                        Transform semantic clusters into a complete site architecture. This module generates URL structure, internal linking strategy, and content hierarchy based on your keyword clusters. Get a ready-to-implement blueprint for your website with AI-powered funnel optimization.
                    </p>
                    
                    <!-- Architecture Type Selection -->
                    <div style="margin-bottom: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                        <label style="font-weight: bold; margin-bottom: 10px; display: block; color: #333;">
                            Architecture Type:
                        </label>
                        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                            <label style="display: none; align-items: center; font-weight: normal;">
                                <input type="radio" name="architectureType" value="silo" style="margin-right: 8px;">
                                <span style="font-weight: bold; color: #e67e22;">SILO</span> - Strict hierarchy without cross-category links
                            </label>
                            <label style="display: flex; align-items: center; font-weight: normal;">
                                <input type="radio" name="architectureType" value="clusters" checked style="margin-right: 8px;">
                                <span style="font-weight: bold; color: #e67e22;">CLUSTERS</span> - Flexible with strategic cross-links
                            </label>
                        </div>
                        
                        <label style="font-weight: bold; margin-bottom: 5px; display: block; color: #333;">
                            Target Domain:
                        </label>
                        <input type="text" id="architectureDomain" value="example.com" 
                               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="margin-bottom: 15px;">
                        <button type="button" id="testArchitectureBtn" style="background: linear-gradient(135deg, #3498db, #2980b9); border: none; color: white; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px;">
                            🧪 Test Module
                        </button>
                        <button type="button" id="generateArchitectureBtn" style="background: linear-gradient(135deg, #e67e22, #d35400); border: none; color: white; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            🏗️ Generate Site Architecture
                        </button>
                    </div>
                    
                    <!-- Progress Section -->
                    <div id="architectureProgress" style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 15px 0; display: none;">
                        <div style="width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                            <div id="architectureProgressFill" style="height: 100%; background: linear-gradient(90deg, #e67e22, #d35400); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="architectureProgressText" style="text-align: center; font-weight: bold; color: #666;">
                            Przygotowywanie generatora...
                        </div>
                        <div id="architectureSteps" style="margin-top: 15px; font-size: 14px; color: #666;"></div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="architectureResults" style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 15px 0; display: none; text-align: left;">
                        <!-- Wyniki generowania architektury będą tutaj -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODUŁ 4: CONTENT BRIEFS -->
        <div class="module-section" id="module4" style="display: none; margin-top:40px;">
            <div class="module-header">
                <h2>📝 MODUŁ 4: CONTENT BRIEF GENERATOR</h2>
                <p>Generuj szczegółowe plany treści dla każdej strony w architekturze</p>
            </div>
            <div class="content-brief-controls">
                <button onclick="generateContentBriefs()" class="btn-primary">
                    🚀 Generuj Content Briefs
                </button>
                <div id="content-brief-results" style="margin-top:20px;"></div>
            </div>
        </div>

        <!-- MODUŁ 5: CONTENT SCAFFOLD DESIGNER -->
        <div class="section-container" id="scaffoldSection" style="display:none;">
            <div class="section-header" style="background:linear-gradient(135deg,#2ecc71,#27ae60);">
                <h2>🧩 MODUŁ 5: CONTENT SCAFFOLD DESIGNER</h2>
            </div>

            <div style="margin:10px 0; display:flex; gap:10px; flex-wrap:wrap;">
                <button id="generateScaffoldBtn">🧠 Generuj Scaffold z Briefu</button>
                <button id="exportScaffoldJsonBtn" style="background:#17a2b8;">📄 Eksport JSON</button>
            </div>

            <div id="scaffoldMetaCard" class="module-status" style="display:none;"></div>

            <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">
                <div style="flex:2; min-width:320px;" id="scaffoldOutline"></div>
                <aside style="flex:1; min-width:280px;" id="dataProvenance">
                    <h4>📎 Pochodzenie danych</h4>
                    <ul id="provenanceList"></ul>
                    <h4>🔗 Link Planner</h4>
                    <div id="linkPlanner"></div>
                </aside>
            </div>
        </div>
    </div>
    
    <!-- Załaduj Sections Loader System -->
    <script src="/static/sections/sections-loader.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // ========================================
        // INITIALIZE APPLICATION
        // ========================================
        
        let currentAnalysisId = null;
        let currentKeywordId = null; // Dodane dla klastrowania
        let currentSemanticClusterId = null; // Dodane dla architektury (Moduł 3)
        
        // Mission Elapsed Time Clock
        const clockEl = document.getElementById('clock');
        if (clockEl) {
            function updateClock(){
                const now = new Date();
                const timeStr = now.toISOString().replace('T', ' ').slice(0, 19) + ' MET';
                clockEl.textContent = timeStr;
            }
            updateClock();
            setInterval(updateClock, 1000);
        }
        
        // Initialize countries dropdown
        async function loadCountries() {
            try {
                const response = await fetch('/api/v6/countries');
                const result = await response.json();
                
                const countrySelect = document.getElementById('country');
                countrySelect.innerHTML = '<option value="">Wybierz kraj...</option>';
                
                result.countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.value;
                    option.textContent = country.text;
                    countrySelect.appendChild(option);
                });
                
                console.log('✅ Kraje załadowane:', result.countries.length);
            } catch (error) {
                console.error('❌ Błąd ładowania krajów:', error);
            }
        }
        
        // Form submission handler
        document.getElementById('keywordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const keyword = document.getElementById('keyword').value.trim();
            const country = document.getElementById('country').value;
            const submitBtn = document.getElementById('submitBtn');
            
            if (!keyword || !country) {
                showMessage('⚠️ Wypełnij wszystkie pola', 'error');
                return;
            }
            
            // Disable button and show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-new btn-icon">⏳</span><span>Analizowanie...</span>';
            
            loadKeywordData(keyword, country);
        });
        
        // ========================================
        // MODULAR KEYWORD DATA LOADING
        // ========================================

        // --- Helpery bezpiecznego renderu linków (snapshot-first) ---
        function safe(val, fallback = "-") {
            if (val === null || val === undefined) return fallback;
            if (typeof val === "string" && val.trim() === "") return fallback;
            return val;
        }

        function lastSegment(url) {
            try {
                if (!url) return "-";
                const u = url.trim().replace(/\/+$/, "");
                const parts = u.split("/");
                return parts[parts.length - 1] || "-";
            } catch {
                return "-";
            }
        }

        function getUrl(link, which) {
            const key = which === "from" ? "from_url" : "to_url";
            let url = link?.[key];
            if (!url || typeof url !== "string" || url.trim() === "") {
                const page = which === "from" ? link?.from_page : link?.to_page;
                const path = page?.url_path;
                if (typeof path === "string" && path.trim() !== "") url = path;
            }
            return safe(url, "-");
        }

        function getTitle(link, which) {
            const titleKey = which === "from" ? "from_title" : "to_title";
            let title = link?.[titleKey];
            if (!title || (typeof title === "string" && title.trim() === "")) {
                const page = which === "from" ? link?.from_page : link?.to_page;
                title = page?.name || page?.cluster_name || null;
            }
            if (!title || (typeof title === "string" && title.trim() === "")) {
                title = lastSegment(getUrl(link, which));
            }
            return safe(title, "-");
        }

        function normalizePlacement(placement) {
            try {
                if (typeof placement === "string" && placement.trim().startsWith("[")) {
                    placement = JSON.parse(placement);
                }
            } catch {
                // ignore
            }
            let key = placement;
            if (Array.isArray(placement)) key = placement[0];
            if (typeof key !== "string") return "-";
            const k = key.trim().toLowerCase();
            if (k === "mid_content") return "content_mid";
            if (k === "content_mid") return "content_mid";
            if (k === "conclusion") return "conclusion";
            if (k === "intro") return "intro";
            if (k === "sidebar") return "sidebar";
            return k || "-";
        }

        function placementLabel(plKey) {
            switch (plKey) {
                case "conclusion": return "zakończenie";
                case "content_mid": return "środek treści";
                case "intro": return "wstęp";
                case "sidebar": return "pasek boczny";
                case "-": return "-";
                default: return plKey;
            }
        }

        function formatSimilarity(link) {
            let s = link?.similarity;
            if (typeof s !== "number") s = link?.confidence_score;
            if (typeof s === "number" && isFinite(s)) {
                if (s > 1 && s <= 100) s = s / 100;
                if (s >= 0 && s <= 1) return Math.round(s * 100) + "%";
            }
            return "-";
        }
        
        async function loadKeywordData(keyword, country) {
            try {
                console.log('🚀 Rozpoczynam pełną analizę SEO (MODULAR):', keyword, country);
                
                // Hide start panel and show legacy containers
                const controlRoom = document.querySelector('.control-room');
                const legacyContainer = document.getElementById('legacyContainer');
                if (controlRoom) controlRoom.style.display = 'none';
                if (legacyContainer) legacyContainer.style.display = 'block';
                
                showMessage('Uruchamiam analizę SEO...', 'success');
                
                // Załaduj wszystkie moduły sekcji
                console.log('🔄 Ładowanie modułów sekcji...');
                if (window.sectionsLoader) {
                    const loadResult = await window.sectionsLoader.loadAllSections();
                    updateModuleStatus();
                }
                
                // KROK 1: Uruchom pełną analizę (API calls + zapis do bazy)
                console.log('🔄 Uruchamiam pełną analizę...');
                showMessage('Analizuję słowo kluczowe przez wszystkie źródła...', 'success');
                
                const analysisResponse = await fetch('/api/v6/analyze-complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        country: country,
                        use_cache: false  // Wyłącz cache dla wersji modularnej
                    })
                });
                
                if (!analysisResponse.ok) {
                    throw new Error(`Błąd analizy: HTTP ${analysisResponse.status}`);
                }
                
                const analysisResult = await analysisResponse.json();
                console.log('✅ Analiza zakończona:', analysisResult);
                
                if (!analysisResult.success) {
                    throw new Error('Analiza nie powiodła się');
                }
                
                // Zapisz keyword_id dla klastrowania
                if (analysisResult.keyword_id) {
                    currentKeywordId = analysisResult.keyword_id;
                    console.log('🔗 Zapisano keyword_id dla klastrowania:', currentKeywordId);
                }
                
                // KROK 2: Pobierz dane z bazy i wyświetl
                console.log('📊 Pobieranie danych z bazy...');
                showMessage('Ładowanie wyników analizy...', 'success');
                
                // Parsuj country do location_code i language_code
                const [location_code, language_code] = country.split('|');
                
                const dataResponse = await fetch(`/api/v6/keyword-data/${encodeURIComponent(keyword)}?location_code=${location_code}&language_code=${language_code}`);
                
                if (!dataResponse.ok) {
                    throw new Error(`Błąd pobierania danych: HTTP ${dataResponse.status}`);
                }
                
                const dataResult = await dataResponse.json();
                console.log('📊 Dane słowa kluczowego:', dataResult);
                
                if (dataResult.success) {
                    // Zapisz dane do zmiennych globalnych dla eksportu
                    currentKeywordData = keyword;
                    currentCountryData = country;
                    
                    // Wywołaj wszystkie funkcje wyświetlania z fallback
                    await displayAllSections(dataResult.data);
                    showResults();
                    showExportSection(); // Pokaż przyciski eksportu
                    showClusteringSection(); // Pokaż sekcję klastrowania
                    showMessage('✅ Analiza zakończona pomyślnie!', 'success');
                } else {
                    throw new Error('Brak danych po analizie');
                }
                
            } catch (error) {
                console.error('❌ Błąd analizy:', error);
                showMessage(`❌ Błąd analizy: ${error.message}`, 'error');
            }
        }
        
        // ========================================
        // DISPLAY ALL SECTIONS WITH FALLBACK
        // ========================================
        
        async function displayAllSections(data) {
            const sections = [
                { id: 1, name: 'displayKeywordHeader', containerId: 'keywordHeader' },
                { id: 2, name: 'displaySeoMetrics', containerId: 'seoMetrics' },
                { id: 3, name: 'displayIntentAnalysis', containerId: 'intentAnalysis' },
                { id: 4, name: 'displayDemographicsAnalysis', containerId: 'demographicsAnalysis' },
                { id: 5, name: 'displayTrendsAnalysis', containerId: 'trendsAnalysis' },
                { id: 6, name: 'displayGeographicAnalysis', containerId: 'geographicAnalysis' },
                // { id: 7, name: 'displayCompetitionAnalysis', containerId: 'competitionAnalysis' }, // disabled by request
                { id: 8, name: 'displayRelatedKeywordsAnalysis', containerId: 'relatedKeywordsAnalysis' },
                { id: 9, name: 'displaySerpAnalysis', containerId: 'serpAnalysis' },
                { id: 10, name: 'displayAutocompleteAnalysis', containerId: 'autocompleteAnalysis' }
            ];
            
            for (const section of sections) {
                try {
                    if (window.sectionsLoader && window.sectionsLoader.isSectionLoaded(section.id)) {
                        console.log(`✅ Używam modularnej SEKCJI ${section.id}`);
                        
                        // Wywołaj modularną funkcję
                        if (window[section.name]) {
                            window[section.name](data);
                        } else {
                            console.warn(`⚠️ Funkcja ${section.name} nie znaleziona`);
                            displayFallbackSection(section.containerId, section.id);
                        }
                    } else {
                        console.log(`⚠️ Używam fallback dla SEKCJI ${section.id}`);
                        displayFallbackSection(section.containerId, section.id, data);
                    }
                } catch (error) {
                    console.error(`❌ Błąd wyświetlania sekcji ${section.id}:`, error);
                    displayErrorSection(section.containerId, section.id, error.message);
                }
            }
        }
        
        function displayFallbackSection(containerId, sectionId, data = null) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Specjalna obsługa dla sekcji 10
            if (sectionId === 10 && data && window.displayAutocompleteAnalysisFallback) {
                window.displayAutocompleteAnalysisFallback(data);
                return;
            }
            
            container.innerHTML = `
                <div style="text-align: center; padding: 30px; color: #666;">
                    <div style="font-size: 36px; margin-bottom: 15px;">⚠️</div>
                    <h3>Sekcja ${sectionId} - Fallback Mode</h3>
                    <p>Moduł sekcji nie jest dostępny. Używana jest uproszczona wersja.</p>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                        Aby uzyskać pełną funkcjonalność, upewnij się że plik 
                        <code>/static/sections/section${sectionId}/section${sectionId}.js</code> 
                        jest dostępny.
                    </div>
                </div>
            `;
        }
        
        function displayErrorSection(containerId, sectionId, errorMessage) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: center; padding: 30px; color: #721c24; background: #f8d7da; border-radius: 4px;">
                    <div style="font-size: 36px; margin-bottom: 15px;">❌</div>
                    <h3>Sekcja ${sectionId} - Błąd</h3>
                    <p>Wystąpił błąd podczas ładowania sekcji.</p>
                    <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                        ${errorMessage}
                    </div>
                </div>
            `;
        }
        
        // ========================================
        // SEMANTIC CLUSTERING FUNCTIONALITY
        // ========================================
        
        function showClusteringSection() {
            document.getElementById('clusteringSection').style.display = 'block';
        }

        function showArchitectureSection() {
            document.getElementById('architectureSection').style.display = 'block';
        }
        
        async function startSemanticClustering() {
            console.log('🔬 CLUSTERING DEBUG: startSemanticClustering wywołana');
            console.log('🔬 CLUSTERING DEBUG: currentKeywordId =', currentKeywordId);
            
            if (!currentKeywordId) {
                console.log('❌ CLUSTERING DEBUG: Brak currentKeywordId');
                showMessage('❌ Brak ID słowa kluczowego. Uruchom najpierw analizę.', 'error');
                return;
            }
            
            const clusteringBtn = document.getElementById('clusteringBtn');
            const progressDiv = document.getElementById('clusteringProgress');
            const resultsDiv = document.getElementById('clusteringResults');
            const progressFill = document.getElementById('clusteringProgressFill');
            const progressText = document.getElementById('clusteringProgressText');
            const stepsDiv = document.getElementById('clusteringSteps');
            
            console.log('🔬 CLUSTERING DEBUG: Elementy DOM:', {
                clusteringBtn: !!clusteringBtn,
                progressDiv: !!progressDiv,
                resultsDiv: !!resultsDiv,
                progressFill: !!progressFill,
                progressText: !!progressText,
                stepsDiv: !!stepsDiv
            });
            
            try {
                // Wyłącz przycisk i pokaż progress
                clusteringBtn.disabled = true;
                clusteringBtn.textContent = '🔄 Clustering in progress...';
                progressDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                
                // Reset progress
                progressFill.style.width = '0%';
                progressText.textContent = 'Starting clustering...';
                stepsDiv.innerHTML = '';
                
                console.log('🔬 CLUSTERING DEBUG: Przygotowuję zapytanie API...');
                
                // Symulacja etapów
                const stages = [
                    { progress: 25, text: 'Collecting keywords...', time: 1000 },
                    { progress: 50, text: 'Generating embeddings...', time: 3000 },
                    { progress: 75, text: 'Performing clustering...', time: 2000 },
                    { progress: 100, text: 'Saving results...', time: 1000 }
                ];
                
                // Rozpocznij klastrowanie
                console.log('🔬 CLUSTERING DEBUG: Wysyłam zapytanie do API...', {
                    keyword_id: currentKeywordId,
                    url: '/api/v6/clustering/start'
                });
                
                const clusteringPromise = fetch('/api/v6/clustering/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyword_id: currentKeywordId
                    })
                });
                
                // Pokaż postęp
                for (const stage of stages) {
                    await new Promise(resolve => setTimeout(resolve, stage.time));
                    progressFill.style.width = stage.progress + '%';
                    progressText.textContent = stage.text;
                    stepsDiv.innerHTML += `<div style="color: #8e44ad;">✅ ${stage.text}</div>`;
                    console.log('🔬 CLUSTERING DEBUG: Progress:', stage.progress + '%', stage.text);
                }
                
                // Poczekaj na wynik
                console.log('🔬 CLUSTERING DEBUG: Czekam na odpowiedź API...');
                const response = await clusteringPromise;
                
                console.log('🔬 CLUSTERING DEBUG: Otrzymana odpowiedź:', {
                    status: response.status,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('🔬 CLUSTERING DEBUG: Błąd odpowiedzi:', errorText);
                    throw new Error(`Błąd klastrowania: HTTP ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ Wynik klastrowania:', result);
                
                if (result.success) {
                    await displayClusteringResults(result.data);
                    
                    // Zapisz cluster ID dla Modułu 3
                    if (result.data.cluster_id) {
                        currentSemanticClusterId = result.data.cluster_id;
                        console.log('🏗️ [ARCHITECTURE] Zapisano semantic cluster ID:', currentSemanticClusterId);
                        
                        // Pokaż sekcję Modułu 3 po udanym klastrowaniu
                        showArchitectureSection();
                    }
                    
                    showMessage('✅ Semantic clustering completed successfully!', 'success');
                } else {
                    throw new Error('Klastrowanie nie powiodło się');
                }
                
            } catch (error) {
                console.error('❌ Błąd klastrowania:', error);
                showMessage(`❌ Clustering error: ${error.message}`, 'error');
                stepsDiv.innerHTML += `<div style="color: #dc3545;">❌ Błąd: ${error.message}</div>`;
            } finally {
                // Przywróć przycisk
                clusteringBtn.disabled = false;
                clusteringBtn.textContent = '🚀 Run Semantic Clustering';
                progressDiv.style.display = 'none';
            }
        }
        
        async function displayClusteringResults(clusteringData) {
            const resultsDiv = document.getElementById('clusteringResults');
            
            if (!clusteringData.groups || clusteringData.groups.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">🤷‍♂️</div>
                        <h3 style="color: #8e44ad; font-size: 20px;">Brak grup semantycznych</h3>
                        <p style="font-size: 14px;">Nie znaleziono wystarczającej liczby fraz do klastrowania lub frazy są zbyt różnorodne.</p>
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            // NASA Mission Control Style - Summary Section
            let html = `
                <div class="clustering-summary">
                    <h3>
                        <span>🧠</span>
                        <span>Clustering Results</span>
                    </h3>
                    <div style="font-size: 14px; margin-bottom: 12px; opacity: 0.95;">
                        Found <strong>${clusteringData.groups_found}</strong> semantic groups 
                        from <strong>${clusteringData.total_phrases}</strong> keywords
                    </div>
                    
                    <div class="clustering-stats">
                        <div class="stat-box">
                            <div class="stat-label">Semantic Groups</div>
                            <div class="stat-value">${clusteringData.groups_found}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total Keywords</div>
                            <div class="stat-value">${clusteringData.total_phrases}</div>
                        </div>
                    </div>
                    
                    <!-- Moduł 3 Ready Indicator -->
                    <div style="background: rgba(230,126,34,0.2); border: 2px solid #e67e22; color: white; padding: 12px; border-radius: 6px; margin-top: 16px; font-size: 13px; text-align: center; font-weight: 600;">
                        🏗️ <strong>MODUŁ 3 GOTOWY!</strong> Klastry można teraz przekształcić w architekturę strony. Przewiń w dół do sekcji "Generator Architektury".
                    </div>
                </div>
                
                <div class="cluster-groups-container">
            `;
            
            // NASA Mission Control Style - Group Cards (UPROSZCZONE!)
            clusteringData.groups.forEach((group, index) => {
                const groupNumber = index + 1;
                const groupName = group.name || `Grupa ${groupNumber}`;
                const phrasesCount = group.phrases.length;
                
                html += `
                    <div class="cluster-group">
                        <div class="cluster-group-header">
                            <div class="cluster-group-title">
                                <div class="cluster-group-number">${groupNumber}</div>
                                <h4>${groupName}</h4>
                            </div>
                            <div class="cluster-group-meta">
                                <span>📊 ${phrasesCount} keywords</span>
                            </div>
                        </div>
                        <div class="cluster-phrases-container">
                `;
                
                // Frazy w grupie (wszystkie równorzędne, bez "representative")
                group.phrases.forEach(phrase => {
                    html += `<span class="cluster-phrase">${phrase}</span>`;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>'; // Koniec cluster-groups-container
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // Event listeners dla przycisków klastrowania
        document.getElementById('clusteringBtn').addEventListener('click', startSemanticClustering);
        document.getElementById('testOpenAIBtn').addEventListener('click', testOpenAIConnection);

        // ========================================
        // MODUŁ 3: ARCHITECTURE GENERATOR FUNCTIONALITY
        // ========================================
        
        // Event listeners dla przycisków architektury
        document.getElementById('generateArchitectureBtn').addEventListener('click', startArchitectureGeneration);
        document.getElementById('testArchitectureBtn').addEventListener('click', testArchitectureConnection);
        
        async function testOpenAIConnection() {
            const testBtn = document.getElementById('testOpenAIBtn');
            const originalText = testBtn.textContent;
            
            try {
                testBtn.disabled = true;
                testBtn.textContent = '🔄 Testowanie...';
                
                console.log('🧪 OPENAI TEST: Rozpoczynam test połączenia OpenAI...');
                
                const response = await fetch('/api/v6/clustering/test-openai');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('🧪 OPENAI TEST: Wynik testu:', result);
                
                if (result.success) {
                    showMessage('✅ Połączenie z OpenAI działa poprawnie!', 'success');
                } else {
                    showMessage(`❌ Problem z OpenAI: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('❌ Błąd testu OpenAI:', error);
                showMessage(`❌ Błąd testu OpenAI: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        async function startArchitectureGeneration() {
            console.log('🏗️ [ARCHITECTURE] startArchitectureGeneration wywołana');
            console.log('🏗️ [ARCHITECTURE] currentSemanticClusterId =', currentSemanticClusterId);
            
            if (!currentSemanticClusterId) {
                console.log('❌ [ARCHITECTURE] Brak currentSemanticClusterId');
                showMessage('❌ Brak ID klastra semantycznego. Uruchom najpierw klastrowanie semantyczne.', 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generateArchitectureBtn');
            const progressDiv = document.getElementById('architectureProgress');
            const resultsDiv = document.getElementById('architectureResults');
            const progressFill = document.getElementById('architectureProgressFill');
            const progressText = document.getElementById('architectureProgressText');
            const stepsDiv = document.getElementById('architectureSteps');
            
            // Get user selections
            const architectureType = document.querySelector('input[name="architectureType"]:checked').value;
            const domain = document.getElementById('architectureDomain').value.trim() || 'example.com';
            
            console.log('🏗️ [ARCHITECTURE] Parametry:', {
                cluster_id: currentSemanticClusterId,
                type: architectureType,
                domain: domain
            });
            
            try {
                // Wyłącz przycisk i pokaż progress
                generateBtn.disabled = true;
                generateBtn.textContent = '🔄 Generowanie w toku...';
                progressDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                
                // Reset progress
                progressFill.style.width = '0%';
                progressText.textContent = 'Rozpoczynanie generowania architektury...';
                stepsDiv.innerHTML = '';
                
                console.log('🏗️ [ARCHITECTURE] Przygotowuję zapytanie API...');
                
                // Symulacja etapów generowania
                const stages = [
                    { progress: 20, text: 'Pobieranie danych klastra semantycznego...', time: 800 },
                    { progress: 40, text: 'Identyfikacja hierarchii przez LLM...', time: 4000 },
                    { progress: 60, text: 'Generowanie struktury URL...', time: 1000 },
                    { progress: 80, text: 'Strategic cross-linking z embeddingami...', time: 2000 },
                    { progress: 100, text: 'Zapisywanie architektury do bazy...', time: 1000 }
                ];
                
                // Rozpocznij generowanie architektury
                console.log('🏗️ [ARCHITECTURE] Wysyłam zapytanie do API...', {
                    semantic_cluster_id: currentSemanticClusterId,
                    architecture_type: architectureType,
                    domain: domain,
                    url: '/api/v6/architecture/generate'
                });
                
                const architecturePromise = fetch('/api/v6/architecture/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        semantic_cluster_id: currentSemanticClusterId,
                        architecture_type: architectureType,
                        domain: domain,
                        save: true,
                        user_preferences: {
                            max_depth: 3,
                            include_local_seo: true,
                            cross_link_threshold: 0.7
                        }
                    })
                });
                
                // Pokaż postęp generowania
                for (const stage of stages) {
                    await new Promise(resolve => setTimeout(resolve, stage.time));
                    progressFill.style.width = stage.progress + '%';
                    progressText.textContent = stage.text;
                    stepsDiv.innerHTML += `<div style="color: #e67e22;">✅ ${stage.text}</div>`;
                    console.log('🏗️ [ARCHITECTURE] Progress:', stage.progress + '%', stage.text);
                }
                
                // Poczekaj na wynik
                console.log('🏗️ [ARCHITECTURE] Czekam na odpowiedź API...');
                const response = await architecturePromise;
                
                console.log('🏗️ [ARCHITECTURE] Otrzymana odpowiedź:', {
                    status: response.status,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('🏗️ [ARCHITECTURE] Błąd odpowiedzi:', errorText);
                    throw new Error(`Błąd generowania architektury: HTTP ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ [ARCHITECTURE] Wynik generowania:', result);
                
                if (result.success) {
                    await displayArchitectureResults(result.data, result.meta);
                    showMessage('✅ Architektura strony wygenerowana pomyślnie!', 'success');
                } else {
                    throw new Error('Generowanie architektury nie powiodło się');
                }
                
            } catch (error) {
                console.error('❌ [ARCHITECTURE] Błąd generowania:', error);
                showMessage(`❌ Błąd generowania architektury: ${error.message}`, 'error');
                stepsDiv.innerHTML += `<div style="color: #dc3545;">❌ Błąd: ${error.message}</div>`;
            } finally {
                // Przywróć przycisk
                generateBtn.disabled = false;
                generateBtn.textContent = '🏗️ Generate Site Architecture';
                progressDiv.style.display = 'none';
            }
        }

        async function displayArchitectureResults(architectureData, meta) {
            const resultsDiv = document.getElementById('architectureResults');
            
            console.log('🏗️ [ARCHITECTURE] Wyświetlam wyniki:', architectureData);
            
            if (!architectureData || !architectureData.url_structure) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #666;">
                        <div style="font-size: 36px; margin-bottom: 15px;">🤷‍♂️</div>
                        <h3>Brak danych architektury</h3>
                        <p>Nie udało się wygenerować struktury architektury strony.</p>
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            const urlStructure = architectureData.url_structure;
            const stats = architectureData.stats || {};
            const seoScore = architectureData.seo_score || 0;
            
            // 🎨 NASA Mission Control CSS - wstrzykiwane dynamicznie
            const nasaCSS = `
                <style>
                .arch-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
                .arch-panel{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);
                    transition:transform .14s ease,box-shadow .14s ease;position:relative;min-height:90px}
                .arch-panel:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
                .arch-code{font-family:ui-monospace,Consolas,monospace;font-size:10px;font-weight:800;color:#0b3d91;
                    background:#e7f3ff;padding:2px 6px;border-radius:3px;letter-spacing:.4px}
                .arch-status{width:7px;height:7px;border-radius:50%;box-shadow:0 0 6px currentColor}
                .arch-label{font-size:10px;color:#6c757d;text-transform:uppercase;font-weight:700;letter-spacing:.3px;margin:6px 0 4px}
                .arch-value{font-size:24px;font-weight:800;font-family:ui-monospace,Consolas,monospace;line-height:1.2;color:#222}
                .arch-badge{display:inline-block;padding:4px 12px;border-radius:6px;font-size:11px;font-weight:800;
                    letter-spacing:.4px;text-transform:uppercase;margin-top:6px}
                .badge-silo{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:1px solid #5a67d8}
                .badge-clusters{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;border:1px solid #e91e63}
                .arch-seo-score{height:24px;background:#f0f2f5;border-radius:12px;overflow:hidden;margin-top:8px;position:relative}
                .arch-seo-fill{height:100%;background:linear-gradient(90deg,#198754 0%,#32cd32 100%);
                    transition:width .8s ease;display:flex;align-items:center;justify-content:flex-end;padding:0 8px}
                .arch-seo-text{font-size:10px;font-weight:800;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.2)}
                .arch-tree{padding:20px;background:#fafbfc;border-radius:6px;margin-top:12px}
                .arch-tree-item{margin:8px 0;padding:12px;background:#fff;border:2px solid;border-radius:8px;
                    box-shadow:0 2px 4px rgba(0,0,0,.04);transition:all .2s ease}
                .arch-tree-item:hover{transform:translateX(4px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
                .arch-tree-pillar{border-color:#9c88c9;background:linear-gradient(135deg,#f3e7ff 0%,#e7d4ff 100%)}
                .arch-tree-cat{border-color:#5b9bd5;background:linear-gradient(135deg,#e7f3ff 0%,#d4e7ff 100%)}
                .arch-tree-sub{border-color:#f5a742;background:linear-gradient(135deg,#fefdf8 0%,#fff8e1 100%)}
                .arch-tree-page{border-color:#e887b6;background:linear-gradient(135deg,#fffafc 0%,#ffe4f0 100%)}
                .arch-tree-connector{margin-left:30px;border-left:2px solid #cbd5e1;padding-left:20px;position:relative}
                .arch-tree-line{position:absolute;left:-22px;top:20px;width:20px;height:2px;background:#cbd5e1}
                .arch-links-table{width:100%;border-collapse:collapse;font-size:10px;margin-top:12px}
                .arch-links-table th{background:#f0f2f5;padding:8px 6px;text-align:left;font-weight:700;border-bottom:2px solid #e5e7eb;
                    color:#0b3d91;text-transform:uppercase;letter-spacing:.2px;position:sticky;top:0}
                .arch-links-table td{padding:8px 6px;border-bottom:1px solid #e5e7eb;font-size:10px}
                .arch-links-table tr:hover{background:#f8f9fa}
                .arch-link-badge{padding:2px 6px;border-radius:3px;font-size:8px;font-weight:700;text-transform:uppercase}
                .arch-badge-high{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
                .arch-badge-medium{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
                .arch-badge-awareness{background:#e7f3ff;color:#004085;border:1px solid #99d3ff}
                .arch-badge-consideration{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
                .arch-badge-decision{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
                .arch-ai-box{background:linear-gradient(135deg,#e7f3ff 0%,#cce7ff 100%);border:2px solid #0b3d91;
                    border-radius:8px;padding:12px;margin:12px 0}
                .arch-ai-title{font-size:11px;color:#0b3d91;font-weight:800;text-transform:uppercase;margin-bottom:6px}
                .arch-ai-text{font-size:10px;color:#0d47a1;line-height:1.5;font-weight:500}
                .arch-detail-card{background:linear-gradient(135deg,#f7f8fa 0%,#eceff3 100%);border:1px solid #e5e7eb;
                    border-radius:8px;padding:12px;transition:all .2s ease}
                .arch-detail-card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
                .arch-note-item{background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:10px;
                    margin-bottom:6px;font-size:10px;line-height:1.5}
                .arch-nav-json{background:#1e1e1e;color:#d4d4d4;padding:12px;border-radius:4px;font-size:9px;
                    font-family:ui-monospace,Consolas,monospace;overflow-x:auto;max-height:200px;overflow-y:auto}
                .arch-diagram{background:#f0f2f5;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin:16px 0;
                    min-height:200px;display:flex;flex-direction:column;align-items:center;gap:16px}
                .arch-diagram-node{background:#fff;border:2px solid #0b3d91;border-radius:8px;padding:8px 12px;
                    font-size:10px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.06);text-align:center;min-width:120px}
                .arch-diagram-arrow{color:#6c757d;font-size:20px;margin:0 4px}
                .arch-opp-card{background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:12px;margin-bottom:8px;
                    transition:all .2s ease}
                .arch-opp-card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
                .arch-action-btn{padding:10px 20px;border:none;border-radius:6px;font-size:11px;font-weight:700;
                    text-transform:uppercase;letter-spacing:.4px;cursor:pointer;transition:all .2s ease;
                    box-shadow:0 2px 8px rgba(0,0,0,.06);flex:1;min-width:180px}
                .arch-btn-export{background:linear-gradient(135deg,#0b3d91 0%,#1560bd 100%);color:#fff}
                .arch-btn-export:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(11,61,145,.3)}
                .arch-btn-csv{background:linear-gradient(135deg,#198754 0%,#20c997 100%);color:#fff}
                .arch-btn-csv:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(25,135,84,.3)}
                .arch-btn-guide{background:linear-gradient(135deg,#fd7e14 0%,#dc3545 100%);color:#fff}
                .arch-btn-guide:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(253,126,20,.3)}
                .diagram-node{background:#fff;border:2px solid #5b9bd5;border-radius:8px;padding:12px 16px;min-width:160px;
                    text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.06);transition:transform .2s ease;font-size:10px;line-height:1.6;
                    word-wrap:break-word;overflow-wrap:break-word}
                .diagram-node:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,.1)}
                .diagram-pillar{border-color:#9c88c9;background:linear-gradient(135deg,#faf8fc 0%,#f5f0fa 100%)}
                .diagram-category{border-color:#5b9bd5;background:linear-gradient(135deg,#f8fbfd 0%,#f0f7fc 100%)}
                .diagram-sub{border-color:#f5a742;background:linear-gradient(135deg,#fffcf8 0%,#fef9f0 100%)}
                .diagram-page{border-color:#e887b6;background:linear-gradient(135deg,#fffafc 0%,#fef5f9 100%)}
                @media (max-width:900px){.diagram-node{min-width:140px;max-width:140px;padding:10px 12px;font-size:9px}}
                @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
                </style>
            `;
            
            let html = nasaCSS + `
                <!-- 🏗️ Mission Control Header -->
                <div style="background:linear-gradient(90deg,#0b3d91,#17a2b8);color:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-radius:8px 8px 0 0;margin-bottom:20px">
                    <div style="display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.6px;text-transform:uppercase;font-size:13px">
                        <span style="width:10px;height:10px;border-radius:50%;background:#32cd32;box-shadow:0 0 10px #32cd32;animation:pulse 2s infinite"></span>
                        Architecture Generated
                    </div>
                    <div style="font-family:ui-monospace,Consolas,monospace;font-size:11px;background:rgba(255,255,255,.15);padding:4px 8px;border-radius:4px">
                        ${new Date().toISOString().slice(0,19).replace('T',' ')} MET
                    </div>
                </div>
                
                <!-- 📊 Stats Grid -->
                <div class="arch-stats-grid">
                    <!-- Typ Architektury -->
                    <div class="arch-panel">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span class="arch-code">ARCH-001</span>
                            <span class="arch-status" style="background:#17a2b8;color:#17a2b8"></span>
                        </div>
                        <div class="arch-label">Architecture Type</div>
                        <div class="arch-value" style="font-size:14px">${architectureData.architecture_type.toUpperCase()}</div>
                        <span class="arch-badge ${architectureData.architecture_type === 'silo' ? 'badge-silo' : 'badge-clusters'}">${architectureData.architecture_type.toUpperCase()}</span>
                    </div>

                    <!-- Liczba Stron -->
                    <div class="arch-panel">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span class="arch-code">PAGES-002</span>
                            <span class="arch-status" style="background:#198754;color:#198754"></span>
                        </div>
                        <div class="arch-label">Pages</div>
                        <div class="arch-value">${stats.total_pages || 0}</div>
                    </div>

                    <!-- Strategic Bridges -->
                    <div class="arch-panel">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span class="arch-code">BRIDGE-003</span>
                            <span class="arch-status" style="background:#fd7e14;color:#fd7e14"></span>
                        </div>
                        <div class="arch-label">Strategic Bridges</div>
                        <div class="arch-value">${stats.cross_links_found || 0}</div>
                    </div>

                    <!-- SEO Score -->
                    <div class="arch-panel">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span class="arch-code">SCORE-004</span>
                            <span class="arch-status" style="background:#198754;color:#198754"></span>
                        </div>
                        <div class="arch-label">SEO Score</div>
                        <div class="arch-value">${seoScore}/100</div>
                        <div class="arch-seo-score">
                            <div class="arch-seo-fill" style="width:${seoScore}%">
                                <span class="arch-seo-text">${seoScore}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Czas Przetwarzania -->
                    <div class="arch-panel">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span class="arch-code">TIME-005</span>
                            <span class="arch-status" style="background:#20c997;color:#20c997"></span>
                        </div>
                        <!-- removed processing time panel -->
                    </div>

                    <!-- Głębokość Struktury -->
                    <div class="arch-panel">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span class="arch-code">DEPTH-006</span>
                            <span class="arch-status" style="background:#17a2b8;color:#17a2b8"></span>
                        </div>
                        <div class="arch-label">Structure Depth</div>
                        <div class="arch-value">${stats.max_depth || 0}</div>
                    </div>
                </div>

                <!-- 📍 URL Structure -->
                <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                    <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                        <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">📍 URL Structure</div>
                    </div>
                    <div class="arch-tree">
            `;
            
            // Pillar page - NASA Style
            if (urlStructure.pillar_page) {
                html += `
                    <div class="arch-tree-item arch-tree-pillar">
                        <div style="display:flex;align-items:center;gap:12px">
                            <span style="font-size:22px">🏛️</span>
                            <div style="flex:1">
                                <div style="font-size:9px;color:#7c6ba8;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">PILLAR</div>
                                <div style="font-weight:800;font-size:13px;color:#222;margin-bottom:4px">${urlStructure.pillar_page.name}</div>
                                <div style="font-size:10px;color:#17a2b8;font-family:ui-monospace,Consolas,monospace;font-weight:600">${urlStructure.pillar_page.url_pattern}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Categories and subcategories - NASA Style with tree connectors
            if (urlStructure.categories) {
                html += `<div class="arch-tree-connector">`;
                
                urlStructure.categories.forEach((category, catIndex) => {
                    html += `
                        <div style="position:relative;margin-bottom:16px">
                            <div class="arch-tree-line"></div>
                            <div class="arch-tree-item arch-tree-cat">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <span style="font-size:20px">📁</span>
                                    <div style="flex:1">
                                        <div style="font-size:8px;color:#4a7fb8;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">CATEGORY ${catIndex + 1}</div>
                                        <div style="font-weight:800;font-size:12px;color:#222;margin-bottom:3px">${category.name}</div>
                                        <div style="font-size:10px;color:#17a2b8;font-family:ui-monospace,Consolas,monospace;font-weight:600">${category.url_pattern}</div>
                                    </div>
                                </div>
                        </div>
                    `;
                    
                    // Subcategories - NASA Style nested
                    if (category.subcategories && category.subcategories.length > 0) {
                        html += `<div class="arch-tree-connector" style="margin-top:12px">`;
                        category.subcategories.forEach((sub, subIndex) => {
                            html += `
                                <div style="position:relative;margin-bottom:12px">
                                    <div class="arch-tree-line"></div>
                                    <div class="arch-tree-item arch-tree-sub">
                                        <div style="display:flex;align-items:center;gap:8px">
                                            <span style="font-size:18px">📄</span>
                                            <div style="flex:1">
                                                <div style="font-size:8px;color:#d98f2e;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">SUB ${catIndex + 1}.${subIndex + 1}</div>
                                                <div style="font-weight:700;font-size:11px;color:#222;margin-bottom:2px">${sub.name}</div>
                                                <div style="font-size:9px;color:#d98f2e;font-family:ui-monospace,Consolas,monospace;font-weight:600">${sub.url_pattern}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    }
                    
                    // Standalone pages - NASA Style
                    if (category.standalone_pages && category.standalone_pages.length > 0) {
                        if (!category.subcategories || category.subcategories.length === 0) {
                            html += `<div class="arch-tree-connector" style="margin-top:12px">`;
                        }
                        category.standalone_pages.forEach((page, pageIndex) => {
                            html += `
                                <div style="position:relative;margin-bottom:12px">
                                    <div class="arch-tree-line"></div>
                                    <div class="arch-tree-item arch-tree-page">
                                        <div style="display:flex;align-items:center;gap:8px">
                                            <span style="font-size:18px">📃</span>
                                            <div style="flex:1">
                                                <div style="font-size:8px;color:#d66fa0;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">PAGE ${catIndex + 1}.${pageIndex + 1}</div>
                                                <div style="font-weight:700;font-size:11px;color:#222;margin-bottom:2px">${page.name}</div>
                                                <div style="font-size:9px;color:#d66fa0;font-family:ui-monospace,Consolas,monospace;font-weight:600">${page.url_pattern}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        if (!category.subcategories || category.subcategories.length === 0) {
                            html += `</div>`;
                    }
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // Strategic Bridges (z bazy - snapshot-first / nowy payload) - NASA STYLE
            const bridgesArr = Array.isArray(architectureData.strategic_bridges) ? architectureData.strategic_bridges : [];
            if (architectureData.architecture_type === 'clusters' && bridgesArr.length > 0) {
                console.debug("🌉 [DISPLAY] strategic_bridges:", bridgesArr.length);
                html += `
                    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                        <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                            <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">🌉 Strategic Cross-Linking (${bridgesArr.length} bridges)</div>
                        </div>
                        <div style="max-height:400px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:4px">
                            <table class="arch-links-table">
                                <thead>
                                    <tr>
                                        <th style="width:180px">Source</th>
                                        <th style="width:180px">Target</th>
                                        <th style="width:140px">Anchor Text</th>
                                        <th style="width:80px">Similarity</th>
                                        <th style="width:80px">Priority</th>
                                        <th style="width:100px">Placement</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                html += bridgesArr.map(link => {
                    const fTitle = getTitle(link, 'from');
                    const tTitle = getTitle(link, 'to');
                    const fUrl = getUrl(link, 'from');
                    const tUrl = getUrl(link, 'to');
                    const anchor = safe(link.anchor_text, `Przejdź: ${fTitle} → ${tTitle}`);
                    const sim = formatSimilarity(link);
                    const prio = safe(link.priority, '-');
                    const place = placementLabel(normalizePlacement(link.placement));
                    if (fTitle === '-' || tTitle === '-' || fUrl === '-' || tUrl === '-') {
                        console.warn('⚠️ [DISPLAY] Strategic bridge missing title/url', { id: link.id, fTitle, tTitle, fUrl, tUrl });
                    }
                    const prioNum = parseInt(prio) || 0;
                    const prioClass = prioNum >= 80 ? 'arch-badge-high' : prioNum >= 60 ? 'arch-badge-medium' : '';
                    return `
                        <tr>
                            <td>${fTitle}</td>
                            <td>${tTitle}</td>
                            <td>${anchor}</td>
                            <td><span style="font-family:ui-monospace,Consolas,monospace;font-weight:800;color:#0b3d91;font-size:11px">${sim}</span></td>
                            <td><span class="arch-link-badge ${prioClass}">${prio}</span></td>
                            <td>${place}</td>
                        </tr>
                    `;
                }).join('');
                html += `</tbody></table></div></div>`;
            }

            // Funnel Links (z bazy) - NASA STYLE
            const funnelArr = Array.isArray(architectureData.funnel_links) ? architectureData.funnel_links : [];
            if (funnelArr.length > 0) {
                console.debug("🔗 [DISPLAY] funnel:", funnelArr.length);
                html += `
                    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                        <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                            <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">🔗 Funnel-optimized Links (${funnelArr.length})</div>
                        </div>
                `;
                // Global funnel reasoning - NASA STYLE
                if (architectureData.funnel_audit && architectureData.funnel_audit.reasoning) {
                    html += `
                        <div class="arch-ai-box" style="margin-bottom:16px">
                            <div class="arch-ai-title">🤖 AI Funnel Reasoning</div>
                            <div class="arch-ai-text">"${architectureData.funnel_audit.reasoning}"</div>
                            <div style="margin-top:8px;font-size:9px;color:#6c757d">
                                <strong>Confidence:</strong> ${architectureData.funnel_audit.confidence_score ? (architectureData.funnel_audit.confidence_score * 100).toFixed(0) + '%' : 'N/A'}
                            </div>
                        </div>
                    `;
                }
                html += `<div style="max-height:400px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:4px">
                    <table class="arch-links-table">
                        <thead>
                            <tr>
                                <th style="width:160px">Source</th>
                                <th style="width:160px">Target</th>
                                <th style="width:130px">Anchor Text</th>
                                <th style="width:70px">Similarity</th>
                                <th style="width:70px">Priority</th>
                                <th style="width:110px">Funnel Stage</th>
                                <th>AI Reasoning</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                html += funnelArr.map(link => {
                    const fTitle = getTitle(link, 'from');
                    const tTitle = getTitle(link, 'to');
                    const fUrl = getUrl(link, 'from');
                    const tUrl = getUrl(link, 'to');
                    const anchor = safe(link.anchor_text, `Przejdź: ${fTitle} → ${tTitle}`);
                    const sim = formatSimilarity(link);
                    const prio = safe(link.priority, '-');
                    const stage = safe(link.funnel_stage, '');
                    const rationale = safe(link.rationale, '');
                    if (fTitle === '-' || tTitle === '-' || fUrl === '-' || tUrl === '-') {
                        console.warn('⚠️ [DISPLAY] Funnel link missing title/url', { id: link.id, fTitle, tTitle, fUrl, tUrl });
                    }
                    const stageClass = stage.toLowerCase() === 'awareness' ? 'arch-badge-awareness' : 
                                       stage.toLowerCase() === 'consideration' ? 'arch-badge-consideration' : 
                                       stage.toLowerCase() === 'decision' ? 'arch-badge-decision' : '';
                    return `
                        <tr>
                            <td>${fTitle}</td>
                            <td>${tTitle}</td>
                            <td>${anchor}</td>
                            <td><span style="font-family:ui-monospace,Consolas,monospace;font-weight:800;color:#0b3d91;font-size:11px">${sim}</span></td>
                            <td><span class="arch-link-badge arch-badge-high">${prio}</span></td>
                            <td><span class="arch-link-badge ${stageClass}">${stage}</span></td>
                            <td style="font-size:9px">${rationale}</td>
                        </tr>
                    `;
                }).join('');
                html += `</tbody></table></div></div>`;
            }
            
            // Internal Linking (hierarchy) z bazy — NASA STYLE
            const hierArr = Array.isArray(architectureData.hierarchy_links) ? architectureData.hierarchy_links : [];
            if (hierArr.length > 0) {
                console.debug("⬆️ [DISPLAY] hierarchy:", hierArr.length);
                html += `
                    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                        <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                            <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">🔗 Internal Linking (${hierArr.length} hierarchical links)</div>
                        </div>
                        <div style="max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:4px">
                            <table class="arch-links-table">
                                <thead>
                                    <tr>
                                        <th style="width:220px">Source</th>
                                        <th style="width:220px">Target</th>
                                        <th style="width:180px">Anchor Text</th>
                                        <th>Placement</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                html += hierArr.map(link => {
                    const fTitle = getTitle(link, 'from');
                    const tTitle = getTitle(link, 'to');
                    const fUrl = getUrl(link, 'from');
                    const tUrl = getUrl(link, 'to');
                    const anchor = safe(link.anchor_text, `Przejdź: ${fTitle} → ${tTitle}`);
                    const place = placementLabel(normalizePlacement(link.placement));
                    if (fTitle === '-' || tTitle === '-' || fUrl === '-' || tUrl === '-') {
                        console.warn('⚠️ [DISPLAY] Hierarchy link missing title/url', { id: link.id, fTitle, tTitle, fUrl, tUrl });
                    }
                    return `
                        <tr>
                            <td>${fTitle}</td>
                            <td>${tTitle}</td>
                            <td>${anchor}</td>
                            <td>${place}</td>
                        </tr>
                    `;
                }).join('');
                html += `</tbody></table></div></div>`;
            }
            
            // Pages Details - NASA STYLE
            if (urlStructure.pillar_page || urlStructure.categories) {
                html += `
                    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                        <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                            <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">📄 Szczegóły Stron</div>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;max-height:350px;overflow-y:auto;padding:4px">
                `;
                
                // Pillar page details
                if (urlStructure.pillar_page) {
                    html += `
                        <div class="arch-detail-card">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                                <span style="font-weight:800;font-size:11px;color:#0b3d91">🏛️ Pillar Page</span>
                                <span style="font-size:18px">📊</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                <span style="color:#6c757d;font-weight:700">Nazwa:</span>
                                <span style="color:#222;font-weight:600">${urlStructure.pillar_page.name}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                <span style="color:#6c757d;font-weight:700">URL:</span>
                                <span style="color:#222;font-weight:600">${urlStructure.pillar_page.url_pattern}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                <span style="color:#6c757d;font-weight:700">Content Length:</span>
                                <span style="color:#222;font-weight:600">~${urlStructure.pillar_page.estimated_word_count || 3000} words</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                <span style="color:#6c757d;font-weight:700">Keywords:</span>
                                <span style="color:#222;font-weight:600">${urlStructure.pillar_page.target_keywords ? urlStructure.pillar_page.target_keywords.slice(0, 3).join(', ') : 'SEO, search optimization'}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Category pages details
                if (urlStructure.categories) {
                    urlStructure.categories.forEach((category, catIndex) => {
                        html += `
                            <div class="arch-detail-card">
                                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                                    <span style="font-weight:800;font-size:11px;color:#0b3d91">📁 Kategoria</span>
                                    <span style="font-size:18px">🎯</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                    <span style="color:#6c757d;font-weight:700">Nazwa:</span>
                                    <span style="color:#222;font-weight:600">${category.name}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                    <span style="color:#6c757d;font-weight:700">URL:</span>
                                    <span style="color:#222;font-weight:600">${category.url_pattern}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                    <span style="color:#6c757d;font-weight:700">Business Intent:</span>
                                    <span style="color:#222;font-weight:600">${category.business_intent || 'High'}</span>
                                </div>
                            </div>
                        `;
                        
                        // Subcategories
                        if (category.subcategories) {
                            category.subcategories.forEach((sub) => {
                                const clusterData = sub.cluster_data || {};
                                html += `
                                    <div class="arch-detail-card">
                                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                                            <span style="font-weight:800;font-size:11px;color:#0b3d91">📄 Subkategoria</span>
                                            <span style="font-size:18px">📋</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">Nazwa:</span>
                                            <span style="color:#222;font-weight:600">${sub.name}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">URL:</span>
                                            <span style="color:#222;font-weight:600">${sub.url_pattern}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">Cluster:</span>
                                            <span style="color:#222;font-weight:600">${clusterData.name || 'N/A'}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">Phrase Count:</span>
                                            <span style="color:#222;font-weight:600">${clusterData.phrase_count || 0}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">Content Length:</span>
                                            <span style="color:#222;font-weight:600">~${sub.estimated_word_count || 2100} words</span>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        
                        // Standalone pages
                        if (category.standalone_pages) {
                            category.standalone_pages.forEach((page) => {
                                const clusterData = page.cluster_data || {};
                                html += `
                                    <div class="arch-detail-card">
                                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                                            <span style="font-weight:800;font-size:11px;color:#0b3d91">📃 Standalone Page</span>
                                            <span style="font-size:18px">⭐</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">Nazwa:</span>
                                            <span style="color:#222;font-weight:600">${page.name}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">URL:</span>
                                            <span style="color:#222;font-weight:600">${page.url_pattern}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">Cluster:</span>
                                            <span style="color:#222;font-weight:600">${clusterData.name || 'N/A'}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">Phrase Count:</span>
                                            <span style="color:#222;font-weight:600">${clusterData.phrase_count || 0}</span>
                                        </div>
                                        <div style="display:flex;justify-content:space-between;margin:4px 0;font-size:9px">
                                            <span style="color:#6c757d;font-weight:700">Content Length:</span>
                                            <span style="color:#222;font-weight:600">~${page.estimated_word_count || 1800} words</span>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    });
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Implementation Notes - NASA STYLE
            if (architectureData.implementation_notes) {
                html += `
                    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                        <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                            <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">📝 Implementation Notes (${Object.keys(architectureData.implementation_notes).length} categories)</div>
                        </div>
                        <div style="max-height:400px;overflow-y:auto;padding:4px">
                `;
                
                Object.entries(architectureData.implementation_notes).forEach(([category, recommendations]) => {
                    if (Array.isArray(recommendations) && recommendations.length > 0) {
                        const catIcons = {'wordpress_tips': '💻', 'technical_seo': '🔧', 'content_strategy': '📄', 'seo': '🎯'};
                        const catIcon = catIcons[category] || '📌';
                        html += `
                            <div style="margin-bottom:16px">
                                <div style="font-size:11px;font-weight:800;color:#0b3d91;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px">
                                    ${catIcon} ${category.replace('_', ' ')} (${recommendations.length} rekomendacji)
                                </div>
                                <ul style="margin:0;padding-left:20px;list-style:none">
                        `;
                        
                        recommendations.forEach(rec => {
                            html += `<li class="arch-note-item" style="padding-left:20px;position:relative">
                                <span style="position:absolute;left:0;top:10px;font-size:14px">▸</span>
                                ${rec}
                            </li>`;
                        });
                        
                        html += `
                                </ul>
                            </div>
                        `;
                    }
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Navigation Structures - NASA STYLE
            if (architectureData.navigation) {
                html += `
                    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                        <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                            <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">🧭 Navigation Structures (${Object.keys(architectureData.navigation).length} systems)</div>
                        </div>
                        <div style="max-height:350px;overflow-y:auto;padding:4px">
                `;
                
                Object.entries(architectureData.navigation).forEach(([navType, structure]) => {
                    html += `
                        <div style="background:#f0f2f5;border:1px solid #e5e7eb;border-radius:6px;padding:12px;margin-bottom:12px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                                <span style="font-size:11px;font-weight:800;color:#0b3d91;text-transform:uppercase">${navType.replace('_', ' ')}</span>
                            </div>
                            <div class="arch-nav-json">
                                ${typeof structure === 'object' ? JSON.stringify(structure, null, 2) : structure}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // --- Nowa sekcja: Potężny diagram linkowania ---
            html += renderLinkingDiagram(urlStructure, architectureData.internal_linking, architectureData.strategic_bridges, architectureData.architecture_type);
            // --- Nowa sekcja: Tabelka potencjału wyszukań dla każdej podstrony ---
            html += renderPageKeywordTable(urlStructure);

            // --- NOWA SEKCJA: Content Opportunities (PAA + AI Overview) ---
            if (architectureData.content_opportunities && architectureData.content_opportunities.length > 0) {
                html += renderContentOpportunities(architectureData.content_opportunities);
            }

            

            // Action buttons - NASA STYLE
            html += `
                <div style="display:flex;gap:12px;flex-wrap:wrap;padding:20px;background:#f0f2f5;border-top:2px solid #e5e7eb;margin-top:20px">
                    <button onclick="exportArchitecture('json')" class="arch-action-btn arch-btn-export">📥 Export JSON</button>
                    <button onclick="exportArchitecture('csv')" class="arch-action-btn arch-btn-csv">📊 Export CSV</button>
                    <button onclick="viewImplementationGuide()" class="arch-action-btn arch-btn-guide">📖 Implementation Guide</button>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';

            // --- AUTOMATYCZNE POKAZYWANIE MODUŁU 4 ---
            // Ustaw globalne ID architektury dla Modułu 4
            window.currentArchitectureId = architectureData.architecture_id || architectureData.id || (architectureData.database_result && architectureData.database_result.architecture_id);
            if (window.currentArchitectureId) {
                console.log('[Moduł 4] Ustawiam currentArchitectureId:', window.currentArchitectureId, architectureData);
            } else {
                console.warn('[Moduł 4] NIE USTAWIONO ID ARCHITEKTURY!', architectureData);
            }
            showModule4();
        }

        async function testArchitectureConnection() {
            const testBtn = document.getElementById('testArchitectureBtn');
            const originalText = testBtn.textContent;
            
            try {
                testBtn.disabled = true;
                testBtn.textContent = '🔄 Testowanie...';
                
                console.log('🧪 [ARCHITECTURE] Rozpoczynam test połączenia modułu...');
                
                const response = await fetch('/api/v6/architecture/test-connection');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('🧪 [ARCHITECTURE] Wynik testu:', result);
                
                if (result.success) {
                    const statusText = `Database: ${result.status.database}, LLM: ${result.status.llm_clients.join(', ')}, Generator: ${result.status.generator}`;
                    showMessage(`✅ Moduł 3 działa poprawnie! ${statusText}`, 'success');
                } else {
                    showMessage(`❌ Problem z Modułem 3: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('❌ [ARCHITECTURE] Błąd testu modułu:', error);
                showMessage(`❌ Błąd testu Modułu 3: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // Utility functions for architecture module
        function exportArchitecture(format) {
            if (!currentSemanticClusterId) {
                showMessage('❌ Brak danych architektury do eksportu', 'error');
                return;
            }
            
            console.log(`📦 [ARCHITECTURE] Eksport architektury w formacie: ${format}`);
            showMessage(`🔄 Eksport architektury w formacie ${format.toUpperCase()}...`, 'info');
            
            // TODO: Implement export functionality
            // This would call /api/v6/architecture/{id}/export?format=json/csv
        }

        function viewImplementationGuide() {
            console.log('📋 [ARCHITECTURE] Otwieranie przewodnika implementacji...');
            
            // TODO: Open modal or new window with implementation guide
            showMessage('📋 Przewodnik implementacji (funkcja w rozwoju)', 'info');
        }
        
        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            if (message) {
                messageContainer.textContent = message;
                messageContainer.className = `message ${type}`;
                if (type === 'info') {
                    messageContainer.style.background = '#f3f6ff';
                    messageContainer.style.border = '1px solid #d9e1ff';
                    messageContainer.style.color = '#1a2b6d';
                } else if (type === 'success') {
                    messageContainer.style.background = '#ecffef';
                    messageContainer.style.border = '1px solid #b7f5c1';
                    messageContainer.style.color = '#0f5132';
                } else if (type === 'error') {
                    messageContainer.style.background = '#ffecec';
                    messageContainer.style.border = '1px solid #ffb3b3';
                    messageContainer.style.color = '#721c24';
                }
                messageContainer.style.display = 'block';
            } else {
                messageContainer.style.display = 'none';
            }
        }
        
        function showResults() {
            document.getElementById('resultsContainer').style.display = 'block';
        }
        
        function updateModuleStatus() {
            const statusContainer = document.getElementById('moduleStatusList');
            const moduleContainer = document.getElementById('moduleStatus');
            
            if (!window.sectionsLoader) {
                statusContainer.innerHTML = '<div class="module-status error">Sections Loader niedostępny</div>';
                moduleContainer.style.display = 'block';
                return;
            }
            
            const status = window.sectionsLoader.getLoadingStatus();
            let html = '';
            
            Object.entries(status).forEach(([sectionId, info]) => {
                const statusClass = info.loaded ? 'loaded' : 'error';
                const statusIcon = info.loaded ? '✅' : '❌';
                
                html += `
                    <div class="module-status ${statusClass}">
                        ${statusIcon} Sekcja ${sectionId}: ${info.title} - ${info.loaded ? 'Załadowana' : 'Niedostępna'}
                    </div>
                `;
            });
            
            statusContainer.innerHTML = html;
            moduleContainer.style.display = 'block';
        }
        
        // ========================================
        // EXPORT FUNCTIONALITY
        // ========================================
        
        let currentKeywordData = null;
        let currentCountryData = null;
        
        function showExportSection() {
            document.getElementById('exportSection').style.display = 'block';
        }
        
        function hideExportSection() {
            document.getElementById('exportSection').style.display = 'none';
        }
        
        async function exportData(format) {
            if (!currentKeywordData || !currentCountryData) {
                showMessage('❌ Brak danych do eksportu. Uruchom najpierw analizę.', 'error');
                return;
            }
            
            try {
                const keyword = currentKeywordData;
                const [location_code, language_code] = currentCountryData.split('|');
                
                showMessage(`📦 Eksportowanie danych do ${format.toUpperCase()}...`, 'success');
                
                // Wywołaj endpoint eksportu
                const response = await fetch(`/api/v6/export-data/${encodeURIComponent(keyword)}?location_code=${location_code}&language_code=${language_code}&format=${format}`);
                
                if (!response.ok) {
                    throw new Error(`Błąd eksportu: HTTP ${response.status}`);
                }
                
                if (format === 'json') {
                    // Dla JSON - pobierz dane i zapisz jako plik
                    const data = await response.json();
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `seo_analysis_${keyword}_${location_code}_${language_code}_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showMessage('✅ Dane JSON zostały zapisane!', 'success');
                } else if (format === 'html') {
                    // Dla HTML - otwórz w nowym oknie
                    const htmlContent = await response.text();
                    const newWindow = window.open();
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();
                    
                    showMessage('✅ Raport HTML został otwarty w nowym oknie!', 'success');
                }
                
                console.log(`✅ Eksport ${format.toUpperCase()} zakończony pomyślnie`);
                
            } catch (error) {
                console.error('❌ Błąd eksportu:', error);
                showMessage(`❌ Błąd eksportu: ${error.message}`, 'error');
            }
        }
        
        // Event listeners dla przycisków eksportu
        document.getElementById('exportJsonBtn').addEventListener('click', function() {
            exportData('json');
        });
        
        document.getElementById('exportHtmlBtn').addEventListener('click', function() {
            exportData('html');
        });
        
        // ========================================
        // INITIALIZE ON DOM LOAD
        // ========================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Inicjalizacja modularnego systemu sekcji...');
            
            // Załaduj kraje
            await loadCountries();
            
            try {
                if (window.sectionsLoader) {
                    // Sprawdź dostępność modułów
                    const section10Available = await window.sectionsLoader.checkSectionAvailability(10);
                    console.log('📊 Status sekcji 10:', section10Available);
                    
                    // Opcjonalnie załaduj sekcję 10 z wyprzedzeniem
                    if (section10Available.available) {
                        await window.sectionsLoader.loadSection(10);
                        console.log('✅ Sekcja 10 załadowana z wyprzedzeniem');
                    } else {
                        console.log('⚠️ Sekcja 10 niedostępna - będzie używany fallback');
                    }
                    
                    // Pokaż status modułów
                    updateModuleStatus();
                } else {
                    console.warn('⚠️ Sections Loader nie dostępny');
                }
            } catch (error) {
                console.error('❌ Błąd inicjalizacji systemu modularnego:', error);
            }
        });

        // VISUAL DIAGRAM: Schemat Linkowania i Mostów - NASA STYLE
        function renderLinkingDiagram(urlStructure, internalLinking, strategicBridges, architectureType) {
            let html = `
                <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                    <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between">
                        <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">🗺️ Schemat Linkowania i Mostów</div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="width:8px;height:8px;border-radius:50%;background:#198754;box-shadow:0 0 6px #198754"></span>
                            <span style="font-size:11px;font-weight:700;color:#198754">VISUAL MAP GENERATED</span>
                        </div>
                    </div>
                    
                    <div style="padding:20px;background:#fafbfc;border-radius:8px;min-height:400px">
            `;
            
            // Row 1: Pillar
            if (urlStructure.pillar_page) {
                html += `
                    <div style="display:flex;justify-content:center;margin-bottom:16px">
                        <div style="background:#fff;border:2px solid #9c88c9;border-radius:8px;padding:12px 16px;min-width:160px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.06);transition:transform .2s ease;background:linear-gradient(135deg,#faf8fc 0%,#f5f0fa 100%)">
                            <div style="font-size:18px;margin-bottom:4px">🏛️</div>
                            <div style="font-size:10px;color:#7c6ba8;font-weight:800;text-transform:uppercase;margin-bottom:4px">PILLAR</div>
                            <div style="font-size:11px;font-weight:700;color:#222;margin-bottom:4px">${urlStructure.pillar_page.name}</div>
                            <div style="font-size:8px;color:#7c6ba8;font-family:ui-monospace,Consolas,monospace">${urlStructure.pillar_page.url_pattern}</div>
                        </div>
                    </div>
                `;
                
                // Row 2: Arrow down
                if (urlStructure.categories && urlStructure.categories.length > 0) {
                    html += `
                        <div style="display:flex;justify-content:center;margin-bottom:16px">
                            <span style="font-size:24px;color:#94a3b8">↓</span>
                        </div>
                    `;
                }
            }
            
            // Row 3: Categories - STRUKTURA KOLUMNOWA dla każdej kategorii
            if (urlStructure.categories && urlStructure.categories.length > 0) {
                // Najpierw renderuj same kategorie z strzałkami między nimi
                html += `<div style="display:flex;justify-content:center;gap:16px;margin-bottom:20px;flex-wrap:wrap">`;
                
                urlStructure.categories.forEach((cat, idx) => {
                    html += `
                        <div style="background:#fff;border:2px solid #5b9bd5;border-radius:8px;padding:12px 16px;min-width:160px;max-width:180px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.06);transition:transform .2s ease;background:linear-gradient(135deg,#f8fbfd 0%,#f0f7fc 100%)">
                            <div style="font-size:18px;margin-bottom:4px">📁</div>
                            <div style="font-size:10px;color:#4a7fb8;font-weight:800;text-transform:uppercase;margin-bottom:4px">KATEGORIA</div>
                            <div style="font-size:11px;font-weight:700;color:#222;margin-bottom:4px;word-wrap:break-word">${cat.name}</div>
                            <div style="font-size:8px;color:#4a7fb8;font-family:ui-monospace,Consolas,monospace;word-wrap:break-word">${cat.url_pattern}</div>
                        </div>
                    `;
                    
                    // Strategic bridge arrow between categories
                    if (idx < urlStructure.categories.length - 1) {
                        html += `<span style="font-size:20px;color:#94a3b8;align-self:center;margin:0 8px">⟷</span>`;
                    }
                });
                
                html += `</div>`;
                
                // Teraz renderuj kolumny: każda kategoria -> strzałka -> sub/page (jeśli istnieje)
                html += `<div style="display:flex;justify-content:center;gap:16px;flex-wrap:wrap">`;
                
                urlStructure.categories.forEach(cat => {
                    const hasSubs = (cat.subcategories && cat.subcategories.length > 0);
                    const hasPages = (cat.standalone_pages && cat.standalone_pages.length > 0);
                    
                    if (hasSubs || hasPages) {
                        // Kolumna dla tej kategorii
                        html += `<div style="display:flex;flex-direction:column;align-items:center;gap:12px;min-width:160px">`;
                        
                        // Strzałka w dół
                        html += `<span style="font-size:24px;color:#94a3b8">↓</span>`;
                        
                        // Sub lub Page
                        const firstSub = cat.subcategories && cat.subcategories[0];
                        const firstPage = !firstSub && cat.standalone_pages && cat.standalone_pages[0];
                        
                        if (firstSub) {
                            html += `
                                <div style="background:#fff;border:2px solid #f5a742;border-radius:8px;padding:12px 16px;width:160px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.06);transition:transform .2s ease;background:linear-gradient(135deg,#fffcf8 0%,#fef9f0 100%)">
                                    <div style="font-size:18px;margin-bottom:4px">📄</div>
                                    <div style="font-size:10px;color:#d98f2e;font-weight:800;text-transform:uppercase;margin-bottom:4px">SUB</div>
                                    <div style="font-size:11px;font-weight:700;color:#222;margin-bottom:4px;word-wrap:break-word">${firstSub.name}</div>
                                    <div style="font-size:8px;color:#d98f2e;font-family:ui-monospace,Consolas,monospace;word-wrap:break-word">${firstSub.url_pattern}</div>
                                </div>
                            `;
                        } else if (firstPage) {
                            html += `
                                <div style="background:#fff;border:2px solid #e887b6;border-radius:8px;padding:12px 16px;width:160px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,.06);transition:transform .2s ease;background:linear-gradient(135deg,#fffafc 0%,#fef5f9 100%)">
                                    <div style="font-size:18px;margin-bottom:4px">📃</div>
                                    <div style="font-size:10px;color:#d66fa0;font-weight:800;text-transform:uppercase;margin-bottom:4px">PAGE</div>
                                    <div style="font-size:11px;font-weight:700;color:#222;margin-bottom:4px;word-wrap:break-word">${firstPage.name}</div>
                                    <div style="font-size:8px;color:#d66fa0;font-family:ui-monospace,Consolas,monospace;word-wrap:break-word">${firstPage.url_pattern}</div>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    }
                });
                
                html += `</div>`;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        // Nowa funkcja: Tabelka potencjału wyszukań - NASA STYLE
        function renderPageKeywordTable(urlStructure) {
            // Zbierz wszystkie podstrony
            const allPages = [];
            if (urlStructure.pillar_page) allPages.push(urlStructure.pillar_page);
            if (urlStructure.categories) {
                urlStructure.categories.forEach(cat => {
                    allPages.push(cat);
                    if (cat.subcategories) allPages.push(...cat.subcategories);
                    if (cat.standalone_pages) allPages.push(...cat.standalone_pages);
                });
            }
            // Buduj tabelę
            let html = `
                <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                    <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                        <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">📊 Potencjał Wyszukań</div>
                    </div>
                    <div style="max-height:400px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:4px">
                        <table class="arch-links-table" style="width:100%">
                    <thead>
                                <tr>
                                    <th style="width:60px">Typ</th>
                                    <th style="width:220px">URL Pattern</th>
                                    <th style="width:80px">Liczba Fraz</th>
                                    <th style="width:280px">Top Phrases</th>
                                    <th style="width:120px">Search Volume</th>
                        </tr>
                    </thead>
                    <tbody>`;
            allPages.forEach(page => {
                const phrases = page.cluster_data?.phrases_with_details || [];
                const totalVolume = phrases.reduce((sum, p) => sum + (p.search_volume || 0), 0);
                const topPhrases = phrases.slice(0, 3).map(p => p.phrase).join(', ');
                const pageIcon = page.page_type === 'pillar' ? '🏛️' : page.page_type === 'category' ? '📁' : page.page_type === 'subcategory' ? '📄' : '📃';
                html += `<tr>
                    <td style="text-align:center"><span style="font-size:16px">${pageIcon}</span></td>
                    <td>${page.url_pattern}</td>
                    <td style="text-align:center">${phrases.length}</td>
                    <td><span style="font-size:9px;color:#6c757d;max-width:300px">${topPhrases}</span></td>
                    <td><span class="volume-value">${totalVolume.toLocaleString()}</span></td>
                </tr>`;
            });
            html += `</tbody></table></div></div>`;
            return html;
        }

        // --- Funkcja renderująca sekcję Content Opportunities - NASA STYLE ---
        function renderContentOpportunities(opportunities) {
            if (!opportunities || opportunities.length === 0) return '';
            let html = `
                <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)">
                    <div style="background:#f0f2f5;padding:10px 16px;border-radius:6px;margin:-20px -20px 16px;border-bottom:2px solid #e5e7eb">
                        <div style="font-weight:800;letter-spacing:.4px;color:#0b3d91;text-transform:uppercase;font-size:12px">📊 Content Opportunities (${opportunities.length} szans wykrytych)</div>
                    </div>
                    <div style="max-height:500px;overflow-y:auto;padding:4px">`;
            opportunities.forEach(opp => {
                // Typ decyzji
                const isFAQ = opp.decision === 'FAQ';
                const isNewPage = opp.decision === 'NEW_PAGE';
                const typeClass = isFAQ ? 'type-faq' : 'type-newpage';
                const typeLabel = isFAQ ? 'FAQ' : isNewPage ? 'NOWA STRONA' : 'OTHER';
                
                // Pytanie/temat
                let mainText = '';
                if (opp.source === 'PAA') {
                    mainText = opp.question || opp.question_or_topic || '(brak)';
                } else if (opp.source === 'AI_OVERVIEW') {
                    mainText = opp.topic || opp.question_or_topic || '(brak)';
                } else {
                    mainText = opp.question_or_topic || '(brak)';
                }
                
                // Strona docelowa
                let target = opp.target_page || opp.suggested_url || '(brak)';
                
                // Źródło
                let sourceLabel = '';
                if (opp.source === 'PAA') {
                    sourceLabel = 'PAA';
                } else if (opp.source === 'AI_OVERVIEW') {
                    sourceLabel = 'AI_OVERVIEW';
                } else {
                    sourceLabel = opp.source || '(brak)';
                }
                
                // Priorytet
                let priority = opp.priority || 'Medium';
                const prioClass = priority.toLowerCase() === 'high' ? 'arch-badge-high' : 'arch-badge-medium';
                
                // Uzasadnienie
                let rationale = opp.rationale || '';
                
                html += `
                    <div class="arch-opp-card">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                            <span class="opp-type ${typeClass}">${typeLabel}</span>
                            <span class="arch-link-badge ${prioClass}">${priority}</span>
                        </div>
                        <div style="font-weight:700;font-size:11px;color:#222;margin:4px 0">${mainText}</div>
                        <div style="font-size:9px;color:#6c757d;display:flex;gap:12px;margin-top:6px;flex-wrap:wrap">
                            <span>📍 Strona docelowa: ${target}</span>
                            <span>🔍 Źródło: ${sourceLabel}</span>
                            <span>⚡ Priorytet: ${priority}</span>
                        </div>
                        ${rationale ? `<div style="font-size:9px;color:#222;line-height:1.4;margin-top:6px;padding-top:6px;border-top:1px solid #e5e7eb"><strong>Uzasadnienie:</strong> ${rationale}</div>` : ''}
                    </div>
                `;
            });
            html += `</div></div>`;
            return html;
        }

        // Funkcja do pobierania ID architektury (przykład: z globalnej zmiennej lub hidden input)
        function getCurrentArchitectureId() {
            // TODO: Dostosuj do swojego systemu!
            if (window.currentArchitectureId) return window.currentArchitectureId;
            const input = document.getElementById('architectureId');
            if (input) return input.value;
            alert('Brak ID architektury!');
            return null;
        }

        // Funkcja do wywołania batch generowania content briefs
        async function generateContentBriefs() {
            const architectureId = getCurrentArchitectureId();
            console.log('[Moduł 4] Wywołuję generateContentBriefs dla architectureId:', architectureId);
            if (!architectureId) return;
            const resultsDiv = document.getElementById("content-brief-results");
            resultsDiv.innerHTML = "⏳ Generowanie content briefs...";
            try {
                const response = await fetch(`/api/content-briefs/batch/${architectureId}`, {
                    method: "POST"
                });
                const data = await response.json();
                if (data.success) {
                    resultsDiv.innerHTML = renderContentBriefsSummary(data);
                } else {
                    resultsDiv.innerHTML = `<span style='color:red;'>Błąd: ${data.error}</span>`;
                }
            } catch (e) {
                resultsDiv.innerHTML = `<span style='color:red;'>Błąd połączenia: ${e}</span>`;
            }
        }

        // Funkcja do renderowania podsumowania briefów
        function renderContentBriefsSummary(data) {
            if (!data || !data.results) return "<b>Brak wyników.</b>";
            let html = `<h4>Podsumowanie Content Briefs</h4><ul style='margin-left:0; padding-left:0;'>`;
            data.results.forEach(res => {
                html += `<li style='margin-bottom:8px;'>
                    <b>${res.page_title}</b>: ${res.status === "success" ? "✅" : "❌"}
                    ${res.status === "success" ? `(<a href="javascript:void(0)" onclick="showContentBriefModal('${res.brief_id}')">Zobacz brief</a>)` : ""}
                    ${res.error ? `<span style='color:red;'>${res.error}</span>` : ""}
                </li>`;
            });
            html += "</ul>";
            return html;
        }

        // Automatyczne pokazywanie sekcji Modułu 4 po wygenerowaniu architektury (jeśli masz taki flow)
        function showModule4() {
            const mod4 = document.getElementById("module4");
            if (mod4) mod4.style.display = "block";
        }
        // Przykład: wywołaj showModule4() po zakończeniu generowania architektury w JS
        // ... w odpowiednim miejscu po displayArchitectureResults lub podobnej funkcji ...
        // showModule4();

        // MODAL NA SZCZEGÓŁY CONTENT BRIEF
        function showContentBriefModal(briefId) {
            const modal = document.getElementById('content-brief-modal');
            const body = document.getElementById('content-brief-modal-body');
            body.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">⏳ Ładowanie briefu...</div>';
            modal.style.display = 'flex';
            fetch(`/api/content-briefs/${briefId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.data) {
                        body.innerHTML = renderContentBriefDetails(data.data);
                    } else {
                        body.innerHTML = `<div style='color:red; text-align:center;'>Błąd: ${data.error || 'Nie znaleziono briefu.'}</div>`;
                    }
                })
                .catch(e => {
                    body.innerHTML = `<div style='color:red; text-align:center;'>Błąd połączenia: ${e}</div>`;
                });
        }
        function closeContentBriefModal() {
            document.getElementById('content-brief-modal').style.display = 'none';
        }

        // Zamknij modal przy kliknięciu poza nim
        window.onclick = function(event) {
            const modal = document.getElementById('content-brief-modal');
            if (event.target == modal) {
                closeContentBriefModal();
            }
        }
// ====== NASA MISSION CONTROL — CONTENT BRIEF GENERATOR ======
        // Renderowanie szczegółów content briefa w stylu NASA Mission Control
        function renderContentBriefDetails(data) {
            if (!data || !data.brief) return '<b>Brak danych briefu.</b>';
            const b = data.brief;
            
            // 🔍 DEBUG: FAQ questions + JSON parsing if needed
            let faqQuestions = b.faq_questions;
            
            // Parse JSON string if needed
            if (typeof faqQuestions === 'string' && faqQuestions.trim().startsWith('[')) {
                try {
                    faqQuestions = JSON.parse(faqQuestions);
                    console.log('🔍 [DEBUG] Parsed FAQ JSON string to array');
                } catch (e) {
                    console.error('❌ [DEBUG] Failed to parse FAQ JSON:', e);
                    faqQuestions = [];
                }
            }
            
            // Ensure FAQ is array
            if (!Array.isArray(faqQuestions)) {
                faqQuestions = [];
            }
            
            console.log('🔍 [DEBUG] FAQ data:', {
                raw_faq: b.faq_questions,
                parsed_faq: faqQuestions,
                faq_type: typeof faqQuestions,
                faq_length: faqQuestions.length
            });
            
            // Parse tone_guidelines if string
            let toneGuidelines = b.tone_guidelines;
            if (typeof toneGuidelines === 'string' && toneGuidelines.trim().startsWith('{')) {
                try {
                    toneGuidelines = JSON.parse(toneGuidelines);
                } catch (e) {
                    console.error('❌ [DEBUG] Failed to parse tone_guidelines JSON:', e);
                    toneGuidelines = {};
                }
            }
            toneGuidelines = typeof toneGuidelines === 'object' && toneGuidelines !== null ? toneGuidelines : {};
            
            // NASA MISSION CONTROL CSS
            const nasaCSS = `
            <style>
            .brief-nasa-root{--bg:#f7f8fa;--panel:#fff;--panel-2:#f0f2f5;--text:#222;--muted:#6c757d;
              --blue:#0b3d91;--blue-2:#1560bd;--green:#198754;--red:#dc3545;--orange:#fd7e14;--purple:#6f42c1;--cyan:#17a2b8;
              --pink:#e91e63;--teal:#20c997;--indigo:#6610f2;--yellow:#ffc107;--lime:#32cd32;
              --border:#e5e7eb;--shadow:0 2px 8px rgba(0,0,0,.06);--gap:10px;--pad:12px;--radius:8px}
            .brief-nasa-root *{box-sizing:border-box}
            .brief-nasa-root{font:12px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;color:var(--text)}
            .brief-card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:12px}
            .brief-header{background:var(--panel-2);padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
            .brief-title{font-weight:800;letter-spacing:.4px;color:var(--blue);text-transform:uppercase;font-size:12px}
            .brief-state{display:flex;align-items:center;gap:8px;font-weight:700;font-size:11px;color:var(--green)}
            .state-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green)}
            .basic-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;padding:16px}
            .info-panel{background:linear-gradient(135deg,#e7f3ff 0%,#cce7ff 100%);border:1px solid var(--blue);
              border-radius:6px;padding:12px;text-align:center;transition:all .2s ease}
            .info-panel:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
            .info-label{font-size:9px;color:var(--blue);font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
            .info-value{font-size:24px;font-weight:900;color:var(--text);font-family:ui-monospace,monospace;line-height:1.2}
            .info-badge{display:inline-block;padding:4px 10px;border-radius:4px;font-size:10px;font-weight:800;margin-top:6px}
            .badge-completed{background:var(--green);color:#fff}
            .badge-transactional{background:var(--orange);color:#fff}
            .badge-informational{background:var(--blue);color:#fff}
            .badge-navigational{background:var(--cyan);color:#fff}
            .badge-awareness{background:#e7f3ff;color:#004085;border:1px solid #99d3ff}
            .badge-consideration{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
            .badge-decision{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
            .psychology-box{background:linear-gradient(135deg,#f3e5f5 0%,#e1bee7 100%);border:2px solid var(--purple);
              border-radius:8px;padding:16px;margin:16px}
            .psych-title{font-size:12px;color:var(--purple);font-weight:800;text-transform:uppercase;margin-bottom:12px;
              display:flex;align-items:center;gap:8px}
            .psych-section{margin-bottom:12px}
            .psych-label{font-size:10px;color:var(--purple);font-weight:800;text-transform:uppercase;margin-bottom:4px}
            .psych-text{font-size:11px;color:var(--text);line-height:1.5}
            .h1-box{background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%);border:2px solid var(--green);
              border-radius:8px;padding:16px;margin:16px}
            .h1-title-text{font-size:16px;font-weight:800;color:var(--text);line-height:1.4}
            .structure-section{padding:16px}
            .h2-item{background:#fff;border:2px solid var(--blue);border-radius:6px;padding:12px;margin-bottom:12px}
            .h2-number{display:inline-block;background:var(--blue);color:#fff;padding:2px 8px;border-radius:3px;
              font-size:10px;font-weight:800;margin-right:8px}
            .h2-text{font-size:12px;font-weight:700;color:var(--text)}
            .h3-container{margin:8px 0 0 24px}
            .h3-item{background:var(--panel-2);border-left:3px solid var(--cyan);padding:8px 12px;margin-bottom:6px;border-radius:4px}
            .h3-number{font-size:9px;color:var(--cyan);font-weight:800;margin-right:6px}
            .h3-text{font-size:11px;font-weight:600;color:var(--text)}
            .keywords-section{padding:16px}
            .keywords-group{margin-bottom:16px}
            .keywords-label{font-size:11px;color:var(--blue);font-weight:800;text-transform:uppercase;margin-bottom:8px}
            .keyword-badge{display:inline-block;padding:4px 10px;border-radius:4px;font-size:10px;font-weight:700;
              margin:4px 4px 4px 0;white-space:nowrap}
            .kw-primary{background:var(--red);color:#fff}
            .kw-semantic{background:var(--blue);color:#fff}
            .kw-related{background:var(--muted);color:#fff}
            .density-list{padding:16px}
            .density-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;
              background:var(--panel-2);border-radius:4px;margin-bottom:6px}
            .density-keyword{font-size:11px;font-weight:600;color:var(--text)}
            .density-value{background:var(--green);color:#fff;padding:3px 8px;border-radius:3px;font-size:9px;font-weight:800}
            .audience-section{padding:16px}
            .audience-box{background:linear-gradient(135deg,#e7f3ff 0%,#cce7ff 100%);border:1px solid var(--blue);
              border-radius:6px;padding:12px;margin-bottom:12px}
            .audience-label{font-size:10px;color:var(--blue);font-weight:800;text-transform:uppercase;margin-bottom:6px}
            .audience-text{font-size:11px;color:var(--text);line-height:1.5}
            .cta-section{padding:16px}
            .cta-card{background:#fff;border:2px solid var(--orange);border-radius:6px;padding:12px;margin-bottom:12px;
              transition:all .2s ease}
            .cta-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(253,126,20,.2)}
            .cta-text{font-size:12px;font-weight:700;color:var(--text);margin-bottom:6px}
            .cta-meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
            .cta-badge{padding:3px 8px;border-radius:3px;font-size:9px;font-weight:700}
            .faq-section{padding:16px}
            .faq-item{background:#fff;border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:10px;
              transition:all .2s ease}
            .faq-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
            .faq-question{font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px}
            .faq-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
            .faq-rationale{font-size:10px;color:var(--muted);line-height:1.4;margin-top:6px;padding-top:6px;border-top:1px solid var(--border)}
            .priority-high{background:#fef2f2;color:#991b1b;border:1px solid #fca5a5;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700}
            .priority-medium{background:#fffbeb;color:#92400e;border:1px solid #fde68a;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700}
            .priority-low{background:#f0f9ff;color:#1e40af;border:1px solid #bfdbfe;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700}
            .source-badge{background:var(--panel-2);color:var(--text);border:1px solid var(--border);padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700}
            .linking-table{width:100%;border-collapse:collapse;font-size:10px;margin-top:12px}
            .linking-table th{background:var(--panel-2);padding:8px 6px;text-align:left;font-weight:700;border-bottom:2px solid var(--border);
              color:var(--blue);text-transform:uppercase;letter-spacing:.2px}
            .linking-table td{padding:8px 6px;border-bottom:1px solid var(--border);font-size:10px;vertical-align:top}
            .linking-table tr:hover{background:var(--panel-2)}
            .linking-container{max-height:400px;overflow:auto;border:1px solid var(--border);border-radius:4px;margin:16px}
            .link-icon{font-size:14px;margin-right:4px}
            .schema-section{padding:16px}
            .schema-card{background:#fff;border:2px solid var(--indigo);border-radius:6px;padding:12px;margin-bottom:12px}
            .schema-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:8px}
            .schema-type{font-size:11px;font-weight:800;color:var(--indigo)}
            .schema-code{background:#1e1e1e;color:#d4d4d4;padding:12px;border-radius:4px;font-size:9px;
              font-family:ui-monospace,monospace;overflow-x:auto;max-height:200px;overflow-y:auto;margin-top:8px}
            .action-bar{display:flex;gap:12px;padding:16px;background:var(--panel-2);border-top:1px solid var(--border);flex-wrap:wrap}
            .action-btn{padding:12px 20px;border:none;border-radius:6px;font-size:11px;font-weight:700;
              text-transform:uppercase;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:8px;
              flex:1;min-width:200px;justify-content:center}
            .btn-green{background:linear-gradient(135deg,var(--green),#28a745);color:#fff}
            .btn-green:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(25,135,84,.3)}
            .btn-blue{background:linear-gradient(135deg,var(--blue),var(--blue-2));color:#fff}
            .btn-blue:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(11,61,145,.3)}
            .btn-orange{background:linear-gradient(135deg,var(--orange),#e8590c);color:#fff}
            .btn-orange:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(253,126,20,.3)}
            .btn-purple{background:linear-gradient(135deg,var(--purple),var(--indigo));color:#fff}
            .btn-purple:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(111,66,193,.3)}
            .brief-footer{background:var(--panel-2);padding:12px 16px;border-top:1px solid var(--border);
              display:flex;justify-content:space-between;font-size:10px;color:var(--muted);flex-wrap:wrap;gap:12px}
            .footer-item{display:flex;align-items:center;gap:6px}
            @media (max-width:900px){
              .basic-grid{grid-template-columns:repeat(2,1fr)}
              .action-bar{flex-direction:column}
              .action-btn{min-width:100%}
            }
            </style>
            `;
            
            // Helper functions
            const getIntentBadge = (intent) => {
                if (!intent) return '';
                const intentLower = intent.toLowerCase();
                if (intentLower.includes('transactional')) return 'badge-transactional';
                if (intentLower.includes('navigational')) return 'badge-navigational';
                return 'badge-informational';
            };
            
            const getFunnelBadge = (stage) => {
                if (!stage) return '';
                const stageLower = stage.toLowerCase();
                if (stageLower.includes('awareness')) return 'badge-awareness';
                if (stageLower.includes('consideration')) return 'badge-consideration';
                if (stageLower.includes('decision')) return 'badge-decision';
                return 'badge-awareness';
            };
            
            // GŁÓWNY HTML - NASA MISSION CONTROL STYLE
            return nasaCSS + `
            <div class="brief-nasa-root">
                
                <!-- Introductory text -->
                <section class="brief-card">
                    <div style="padding:14px 16px;font-size:12px;color:#0b3d91;line-height:1.5">
                        A content brief is your complete blueprint for creating high-quality, SEO-optimized content. This AI-powered brief includes keyword research, content structure, psychological insights, and detailed writing instructions. Use it to guide your writers or create content yourself with confidence.
                    </div>
                </section>
                
                <!-- 1. Basic Info Grid -->
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">📊 Basic Info</div>
                        <div class="brief-state"><span class="state-dot"></span> BRIEF GENERATED</div>
                    </div>
                    
                    <div class="basic-grid">
                        <div class="info-panel">
                            <div class="info-label">Target Words</div>
                            <div class="info-value">${b.word_count_target || '-'}</div>
                    </div>
                        
                        <div class="info-panel">
                            <div class="info-label">Content Intent</div>
                            <div class="info-value" style="font-size:14px">${b.content_intent || 'INFO'}</div>
                            <span class="info-badge ${getIntentBadge(b.content_intent)}">${(b.content_intent || 'INFORMATIONAL').toUpperCase()}</span>
                    </div>
                        
                        <div class="info-panel">
                            <div class="info-label">Difficulty</div>
                            <div class="info-value" style="font-size:16px;text-transform:capitalize">${b.content_difficulty || 'Intermediate'}</div>
                    </div>
                        
                        <div class="info-panel">
                            <div class="info-label">Status</div>
                            <div class="info-value" style="font-size:14px">${b.brief_status || 'DONE'}</div>
                            <span class="info-badge badge-completed">COMPLETED</span>
                        </div>
                        
                        ${toneGuidelines.funnel_stage ? `
                        <div class="info-panel">
                            <div class="info-label">Funnel Stage</div>
                            <div class="info-value" style="font-size:12px;text-transform:uppercase">${toneGuidelines.funnel_stage}</div>
                            <span class="info-badge ${getFunnelBadge(toneGuidelines.funnel_stage)}">${toneGuidelines.funnel_stage.toUpperCase()}</span>
                    </div>
                    ` : ''}
                </div>
                </section>

                <!-- 2. Psychology-Enhanced Box -->
                ${toneGuidelines.psychology_applied || toneGuidelines.customer_mindset ? `
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">🧠 Psychology-Enhanced Content Brief</div>
                        <div class="brief-state"><span class="state-dot"></span> AI ENHANCED</div>
                        </div>
                    
                    <div class="psychology-box">
                        <div style="font-size:11px;color:#6f42c1;margin-bottom:10px">
                            AI-powered psychological insights guide your content to connect with readers on an emotional level. Understanding your audience's mindset, journey, and triggers helps create content that resonates and converts.
                    </div>
                        <div class="psych-title">
                            <span>🧠</span>
                            <span>Psychology Context</span>
                    </div>
                        
                        ${toneGuidelines.customer_mindset ? `
                        <div class="psych-section">
                            <div class="psych-label">Customer Mindset</div>
                            <div class="psych-text">${toneGuidelines.customer_mindset}</div>
                        </div>
                    ` : ''}
                        
                        ${toneGuidelines.emotional_journey ? `
                        <div class="psych-section">
                            <div class="psych-label">Emotional Journey</div>
                            <div class="psych-text">${toneGuidelines.emotional_journey}</div>
                        </div>
                    ` : ''}
                        
                        ${toneGuidelines.psychology_triggers_used && toneGuidelines.psychology_triggers_used.length ? `
                        <div class="psych-section">
                            <div class="psych-label">Psychology Triggers</div>
                            <div class="psych-text">${toneGuidelines.psychology_triggers_used.join(', ')}</div>
                        </div>
                    ` : ''}
                        
                        ${toneGuidelines.writer_instructions && toneGuidelines.writer_instructions.psychology_integration ? `
                        <div class="psych-section">
                            <div class="psych-label">Writer Instructions</div>
                            <div class="psych-text">${toneGuidelines.writer_instructions.psychology_integration}</div>
                        </div>
                    ` : ''}
                </div>
                </section>
                ` : ''}

                <!-- 3. H1 Title -->
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">📋 H1 Title</div>
                        <div class="brief-state"><span class="state-dot"></span> TITLE READY</div>
                    </div>
                    
                    <div class="h1-box">
                        <div class="h1-title-text">${b.h1_title || '(brak tytułu)'}</div>
                </div>
                </section>

                <!-- 4. Content Structure H2/H3 -->
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">📋 Content Structure (H2/H3)</div>
                        <div class="brief-state"><span class="state-dot"></span> STRUCTURE MAPPED</div>
                    </div>
                    
                    <div class="structure-section">
                        ${b.h2_structure && b.h2_structure.length ? b.h2_structure.map((h2, index) => `
                            <div class="h2-item">
                                <span class="h2-number">H2.${index + 1}</span>
                                <span class="h2-text">${h2}</span>
                                
                                ${b.h3_structure && b.h3_structure[h2] ? `
                                <div class="h3-container">
                                    ${b.h3_structure[h2].map((h3, h3Index) => `
                                        <div class="h3-item">
                                            <span class="h3-number">H3.${index + 1}.${h3Index + 1}</span>
                                            <span class="h3-text">${h3}</span>
                                    </div>
                                    `).join('')}
                            </div>
                                ` : ''}
                    </div>
                        `).join('') : '<div style="padding:16px;color:#666;font-style:italic">Brak struktury H2/H3</div>'}
                </div>
                </section>

                <!-- 5. Keywords -->
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">🔑 Keywords</div>
                        <div class="brief-state"><span class="state-dot"></span> KEYWORDS ANALYZED</div>
                    </div>
                    
                    <div class="keywords-section">
                    ${b.primary_keywords && b.primary_keywords.length ? `
                        <div class="keywords-group">
                            <div class="keywords-label">Primary Keywords</div>
                            ${b.primary_keywords.map(kw => `<span class="keyword-badge kw-primary">${kw}</span>`).join('')}
                    </div>
                    ` : ''}
                    
                    ${b.semantic_keywords && b.semantic_keywords.length ? `
                        <div class="keywords-group">
                            <div class="keywords-label">Semantic Keywords (max 10)</div>
                            ${b.semantic_keywords.slice(0, 10).map(kw => `<span class="keyword-badge kw-semantic">${kw}</span>`).join('')}
                    </div>
                    ` : ''}

                    ${b.related_keywords && b.related_keywords.length ? `
                        <div class="keywords-group">
                            <div class="keywords-label">Related Keywords</div>
                            ${b.related_keywords.map(kw => `<span class="keyword-badge kw-related">${kw}</span>`).join('')}
                    </div>
                    ` : ''}
                </div>
                </section>

                <!-- 6. Keyword Density Targets -->
                ${b.keyword_density_targets && Object.keys(b.keyword_density_targets).length ? `
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">🎯 Keyword Density Targets</div>
                        <div class="brief-state"><span class="state-dot"></span> TARGETS SET</div>
                    </div>
                    
                    <div class="density-list">
                            ${Object.entries(b.keyword_density_targets).map(([keyword, density]) => `
                            <div class="density-item">
                                <span class="density-keyword">${keyword}</span>
                                <span class="density-value">${density}</span>
                            </div>
                            `).join('')}
                    </div>
                </section>
                ` : ''}

                <!-- 7. Target Audience & Tone -->
                ${b.target_audience || toneGuidelines ? `
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">👥 Target Audience & Tone Guidelines</div>
                        <div class="brief-state"><span class="state-dot"></span> AUDIENCE DEFINED</div>
                    </div>
                    
                    <div class="audience-section">
                    ${b.target_audience ? `
                        <div class="audience-box">
                            <div class="audience-label">Target Audience</div>
                            <div class="audience-text">${b.target_audience}</div>
                    </div>
                    ` : ''}

                        ${toneGuidelines ? `
                        <div class="audience-box">
                            <div class="audience-label">Tone Guidelines</div>
                            <div class="audience-text">
                                ${toneGuidelines.tone_guidelines ? `<strong>Style:</strong> ${toneGuidelines.tone_guidelines}<br>` : ''}
                                ${toneGuidelines.content_difficulty ? `<strong>Level:</strong> ${toneGuidelines.content_difficulty}` : ''}
                                ${toneGuidelines.word_count_target ? ` - ${toneGuidelines.word_count_target} words<br>` : '<br>'}
                                ${toneGuidelines.psychology_triggers_used && toneGuidelines.psychology_triggers_used.length ? `<strong>Triggers:</strong> ${toneGuidelines.psychology_triggers_used.join(', ')}` : ''}
                                            </div>
                                        </div>
                                    ` : ''}

                        ${toneGuidelines.psychology_context ? `
                        <div class="audience-box">
                            <div class="audience-label">Psychology Context</div>
                            <div class="audience-text">${toneGuidelines.psychology_context}</div>
                                    </div>
                                ` : ''}
                                
                        ${toneGuidelines.pain_points_addressed && toneGuidelines.pain_points_addressed.length ? `
                        <div class="audience-box">
                            <div class="audience-label">Pain Points</div>
                            <div class="audience-text">
                                ${toneGuidelines.pain_points_addressed.map(pain => `• ${pain}`).join('<br>')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                        ${toneGuidelines.writer_instructions && toneGuidelines.writer_instructions.psychology_integration ? `
                        <div class="audience-box">
                            <div class="audience-label">Writer Instructions</div>
                            <div class="audience-text">${toneGuidelines.writer_instructions.psychology_integration}</div>
                                    </div>
                                ` : ''}
                    </div>
                </section>
                ` : ''}
                
                <!-- 8. CTA Recommendations -->
                ${b.cta_recommendations && b.cta_recommendations.length ? `
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">📞 CTA Recommendations</div>
                        <div class="brief-state"><span class="state-dot"></span> CTAs OPTIMIZED</div>
                    </div>
                    
                    <div class="cta-section">
                        ${b.cta_recommendations.map(cta => `
                            <div class="cta-card">
                                <div class="cta-text">${cta.text || cta.cta_text || 'CTA'}</div>
                                <div class="cta-meta">
                                    ${cta.type || cta.cta_type ? `<span class="cta-badge" style="background:var(--blue);color:#fff">Type: ${cta.type || cta.cta_type}</span>` : ''}
                                    ${cta.placement ? `<span class="cta-badge" style="background:var(--green);color:#fff">Placement: ${cta.placement}</span>` : ''}
                                    ${cta.priority ? `<span class="cta-badge" style="background:var(--orange);color:#fff">Priority: ${cta.priority.toUpperCase()}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>
                ` : ''}
                
                <!-- 9. FAQ Questions -->
                ${faqQuestions && faqQuestions.length ? `
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">❓ FAQ Questions</div>
                        <div class="brief-state"><span class="state-dot"></span> ${faqQuestions.length} QUESTIONS IDENTIFIED</div>
                    </div>
                    
                    <div class="faq-section">
                        ${faqQuestions.map(faq => {
                            let priorityIcon = '📝';
                            if (faq.priority === 'high') priorityIcon = '🔥';
                            else if (faq.priority === 'medium') priorityIcon = '⚡';
                            
                            let sourceBadge = '';
                            if (faq.source) {
                                if (faq.source.includes('PAA')) sourceBadge = '🔍 PAA';
                                else if (faq.source.includes('AI_OVERVIEW')) sourceBadge = '🤖 AI Overview';
                                else if (faq.source.includes('module3')) sourceBadge = '🏗️ Module 3';
                                else sourceBadge = faq.source;
                            }
                            
                            return `
                                <div class="faq-item">
                                    <div class="faq-question">${priorityIcon} ${faq.question}</div>
                                    <div class="faq-meta">
                                        <span class="priority-${faq.priority || 'medium'}">${priorityIcon} ${(faq.priority || 'medium').toUpperCase()}</span>
                                        ${sourceBadge ? `<span class="source-badge">${sourceBadge}</span>` : ''}
                                    </div>
                                    ${faq.rationale ? `
                                        <div class="faq-rationale">
                                            <strong>Rationale:</strong> ${faq.rationale}
                                        </div>
                                    ` : ''}
                                    ${faq.psychology_context ? `
                                        <div class="faq-rationale">
                                            <strong>Psychology Context:</strong> ${faq.psychology_context}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                        </div>
                </section>
                ` : ''}
                
                <!-- 10. Internal Linking Instructions -->
                ${data.linking_instructions && data.linking_instructions.length ? `
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">🔗 Internal Linking Instructions</div>
                        <div class="brief-state"><span class="state-dot"></span> ${data.linking_instructions.length} Links Planned</div>
                    </div>
                    
                    <div class="linking-container">
                        <table class="linking-table">
                        <thead>
                                <tr>
                                    <th style="width:80px">Type</th>
                                    <th style="width:180px">Target Page</th>
                                    <th style="width:150px">Anchor Text</th>
                                    <th style="width:100px">Placement</th>
                                    <th>Purpose/Rationale</th>
                                    <th style="width:80px">Priority</th>
                                    <th style="width:100px">Stage</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.linking_instructions.map(link => {
                                    let typeIcon = '🔗';
                                const linkType = link.link_type || '';
                                switch(linkType) {
                                    case 'hierarchy': typeIcon = '⬆️'; break;
                                    case 'bridge': typeIcon = '🌉'; break;
                                    case 'funnel': typeIcon = '🎯'; break;
                                    case 'pillar_link': typeIcon = '🏛️'; break;
                                    case 'cluster_link': typeIcon = '🔗'; break;
                                }
                                
                                const priority = link.priority || link.link_priority || 'medium';
                                    let priorityClass = 'priority-medium';
                                    if (priority === 'high' || priority === 'highest') priorityClass = 'priority-high';
                                    else if (priority === 'low') priorityClass = 'priority-low';
                                    
                                const targetTitle = link.target_title || link.target_url || link.link_purpose || '(unknown)';
                                const targetUrl = link.target_url || '#';
                                const purpose = link.rationale || link.context || link.context_suggestion || link.link_purpose || '-';
                                const funnelStage = link.funnel_stage || '-';
                                    const funnelBadgeClass = getFunnelBadge(funnelStage);
                                
                                return `
                                    <tr>
                                            <td><span class="link-icon">${typeIcon}</span>${link.link_type}</td>
                                            <td>
                                                <div style="font-weight:bold;margin-bottom:2px">${targetTitle}</div>
                                                <div style="font-family:monospace;font-size:10px;color:#666">${targetUrl}</div>
                                        </td>
                                            <td style="color:#0066cc;font-weight:600">"${link.anchor_text || '(no anchor)'}"</td>
                                            <td>${link.placement_section || link.placement || '-'}</td>
                                            <td style="font-size:10px;line-height:1.3">${purpose.length > 50 ? purpose.substring(0, 50) + '...' : purpose}</td>
                                            <td style="text-align:center"><span class="${priorityClass}">${priority.toUpperCase()}</span></td>
                                            <td style="text-align:center"><span class="keyword-badge ${funnelBadgeClass}">${funnelStage}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    </div>
                </section>
                ` : ''}

                <!-- 11. Schema.org Templates -->
                ${data.schema_templates && data.schema_templates.length ? `
                <section class="brief-card">
                    <div class="brief-header">
                        <div class="brief-title">🛠️ Schema.org Templates</div>
                        <div class="brief-state"><span class="state-dot"></span> ${data.schema_templates.length} Schemas Ready</div>
                    </div>
                    
                    <div class="schema-section">
                    ${data.schema_templates.map(schema => `
                            <div class="schema-card">
                                <div class="schema-header">
                                    <span class="schema-type">${schema.schema_type} Schema</span>
                                    <div>
                                        <span class="priority-${schema.schema_priority === 'high' ? 'high' : 'medium'}">${(schema.schema_priority || 'medium').toUpperCase()} Priority</span>
                            </div>
                                </div>
                                <div class="schema-code">${JSON.stringify(schema.json_ld, null, 2)}</div>
                        </div>
                    `).join('')}
                </div>
                </section>
                ` : ''}
                
                <!-- 12. Action Buttons -->
                <section class="brief-card">
                    <div class="action-bar">
                        <button class="action-btn btn-green" onclick="copyToClipboard('${(b.h1_title || '').replace(/'/g, "\\'")}')" title="Copy the H1 title to clipboard">
                        📋 Copy H1 Title
                    </button>
                        <button class="action-btn btn-blue" onclick="exportContentBrief('${b.id}')" title="Export content brief to file">
                            📥 Export Brief
                    </button>
                        <button class="action-btn btn-orange" onclick="generateContent('${b.id}')" title="Generate content based on this brief">
                            ✨ Generate Content
                    </button>
                        <button class="action-btn btn-purple" onclick="generateComprehensiveScaffold('${b.id}')" title="Creates a detailed writing guide with section-by-section instructions, word counts, internal links, and writer guidelines. Perfect for delegating content creation.">
                            🏗️ Generate Content Scaffold
                    </button>
                </div>
                </section>

                <!-- 13. Footer Info -->
                <section class="brief-card">
                    <div class="brief-footer">
                        <div class="footer-item">
                            <span>📅</span>
                            <span>Created: ${b.created_at ? b.created_at.split('T')[0] : '-'}</span>
                </div>
                        <div class="footer-item">
                            <span>🆔</span>
                            <span>Brief ID: ${b.id}</span>
                        </div>
                    </div>
                </section>

            </div>
            `;
        }
        // Zmień link w podsumowaniu na onclick
        const origRenderContentBriefsSummary = renderContentBriefsSummary;
        renderContentBriefsSummary = function(data) {
            if (!data || !data.results) return "<b>Brak wyników.</b>";
            let html = `<h4>Podsumowanie Content Briefs</h4><ul style='margin-left:0; padding-left:0;'>`;
            data.results.forEach(res => {
                html += `<li style='margin-bottom:8px;'>
                    <b>${res.page_title}</b>: ${res.status === "success" ? "✅" : "❌"}
                    ${res.status === "success" ? `(<a href="javascript:void(0)" onclick="showContentBriefModal('${res.brief_id}')">Zobacz brief</a>)` : ""}
                    ${res.error ? `<span style='color:red;'>${res.error}</span>` : ""}
                </li>`;
            });
            html += "</ul>";
            return html;
        }

        // Helper functions for Content Brief modal
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('H1 title skopiowany do schowka!');
            }).catch(err => {
                console.error('Błąd kopiowania:', err);
                alert('Błąd kopiowania do schowka.');
            });
        }

        function exportContentBrief(briefId) {
            console.log('Export brief:', briefId);
            alert('Export functionality - TODO');
        }

        function generateContent(briefId) {
            console.log('Generate content for brief:', briefId);
            alert('Content generation - TODO');
        }

        // ========================================
        // MODUŁ 5: CONTENT SCAFFOLD GENERATOR FUNCTIONS
        // ========================================

        async function generateComprehensiveScaffold(briefId) {
            console.log('🧠 [SCAFFOLD] Generowanie comprehensive scaffold dla brief:', briefId);
            
            if (!briefId) {
                alert('❌ Brak ID briefu!');
                return;
            }
            
            // Pokaż modal z progress
            showScaffoldModal('generating', briefId);
            
            try {
                const response = await fetch(`/api/content-briefs/${briefId}/generate-comprehensive-scaffold`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ [SCAFFOLD] Scaffold wygenerowany:', result.meta);
                    showScaffoldModal('success', briefId, result.data, result.meta);
                } else {
                    console.error('❌ [SCAFFOLD] Błąd generowania:', result.error);
                    showScaffoldModal('error', briefId, null, { error: result.error });
                }
                
            } catch (error) {
                console.error('❌ [SCAFFOLD] Błąd połączenia:', error);
                showScaffoldModal('error', briefId, null, { error: error.message });
            }
        }

        function showScaffoldModal(state, briefId, scaffoldData = null, meta = null) {
            // Utwórz modal jeśli nie istnieje
            let modal = document.getElementById('scaffold-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'scaffold-modal';
                modal.style.cssText = `
                    display: none;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    overflow: auto;
                    background-color: rgba(0,0,0,0.4);
                    align-items: center;
                    justify-content: center;
                `;
                modal.innerHTML = `
                    <div style="background: white; margin: 15px; padding: 20px; border-radius: 8px; width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                            <h2 style="margin: 0; color: #333;">Content Scaffold</h2>
                            <button onclick="closeScaffoldModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                        </div>
                        <div id="scaffold-modal-body">Loading...</div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            const body = document.getElementById('scaffold-modal-body');
            
            // Ustaw tytuł na podstawie stanu
            const titleElement = modal.querySelector('h2');
            if (state === 'generating') {
                titleElement.textContent = '🧠 GENEROWANIE COMPREHENSIVE SCAFFOLD';
                body.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#666;">
                        <div style="font-size:48px; margin-bottom:20px; animation: spin 2s linear infinite;">🧠</div>
                        <h3>Generowanie ultra-szczegółowego scaffolda...</h3>
                        <p>To może potrwać 30-60 sekund. System analizuje:</p>
                        <ul style="text-align:left; max-width:400px; margin:20px auto;">
                            <li>🔍 Semantic clusters z similarity scores</li>
                            <li>🌉 Strategic bridges z embeddingami</li>
                            <li>🧠 Psychology triggers z funnel stages</li>
                            <li>💡 Content opportunities (PAA + AI Overview)</li>
                            <li>❓ FAQ integration z priority mapping</li>
                            <li>📞 CTA optimization z psychology triggers</li>
                            <li>🛠️ Schema markup guidance</li>
                        </ul>
                        <div style="background:#e8f4fd; border-radius:6px; padding:15px; margin-top:20px; font-size:14px; color:#1976d2;">
                            <strong>💡 Pro tip:</strong> Ten scaffold będzie zawierał mega-szczegółowe instrukcje dla content writera, 
                            włączając psychology reasoning dla każdego linku strategicznego!
                        </div>
                    </div>
                `;
            } else if (state === 'success') {
                titleElement.textContent = '✅ Content Scaffold Generated';
                
                // Tylko uproszczony widok bez przełączania
                const actionsHtml = `
                  <div id="scaffold-actions" style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                    <button id="btn-copy-outline" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; cursor:pointer;">📋 Copy Outline (H2/H3)</button>
                    <button id="btn-export-json" style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; cursor:pointer;">💾 Export JSON</button>
                    <button onclick="copyScaffoldContent()" style="padding:8px 12px; border:1px solid #28a745; background:#28a745; color:white; border-radius:6px; cursor:pointer;">📋 Copy Full Plan</button>
                  </div>
                  <div id="scaffold-simplified-view">
                    ${renderSimplifiedScaffold(scaffoldData, meta)}
                  </div>
                `;
                
                body.innerHTML = actionsHtml;
                
                (function(){
                    const modal = document.getElementById('scaffold-modal');
                    modal.addEventListener('click', async (e)=>{
                        const bAll = e.target.closest('[data-copy-scaffold="json"]');
                        if (bAll){
                            try {
                                const payload = JSON.stringify(scaffoldData || {}, null, 2);
                                await navigator.clipboard.writeText(payload);
                                if (window.showMessage) window.showMessage('Skopiowano JSON scaffoldu.', 'info');
                            } catch(err){
                                if (window.showMessage) window.showMessage('Nie udało się skopiować JSON.', 'error');
                            }
                        }
                        const bSec = e.target.closest('[data-copy-section]');
                        if (bSec){
                            const idx = bSec.getAttribute('data-copy-section');
                            const box = modal.querySelector(`#scaffold-sec-${idx}`);
                            if (box){
                                try {
                                    await navigator.clipboard.writeText(box.innerText.trim());
                                    if (window.showMessage) window.showMessage('Sekcja skopiowana do schowka.', 'info');
                                } catch(err){
                                    if (window.showMessage) window.showMessage('Kopiowanie nieudane.', 'error');
                                }
                            }
                        }
                    });
                    // Designer helpers
                    (function(){
                      const data = scaffoldData || {};
                      const sections = Array.isArray(data.content_sections) ? data.content_sections : [];
                      function toOutlineMarkdown(){
                        let md = `# ${meta?.h1_title || 'Outline'}\n\n`;
                        sections.forEach((sec, i)=>{
                          const h2 = sec?.h2 || `Sekcja ${i+1}`;
                          md += `## ${h2}\n`;
                          const subs = Array.isArray(sec?.subsections) ? sec.subsections : [];
                          subs.forEach(s=>{ 
                            const h3 = s?.h3 || ''; if (h3) md += `### ${h3}\n`;
                            const bullets = Array.isArray(s?.bullet_points)? s.bullet_points : [];
                            if (bullets.length){ bullets.forEach(bp=>{ md += `- ${bp}\n`; }); md += `\n`; }
                          });
                          md += `\n`;
                        });
                        return md;
                      }
                      function downloadJSON(obj, filename){
                        const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                      }
                      const btnCopy = document.getElementById('btn-copy-outline');
                      const btnExport = document.getElementById('btn-export-json');
                      if (btnCopy) btnCopy.onclick = async ()=>{ try { await navigator.clipboard.writeText(toOutlineMarkdown()); alert('✅ Outline skopiowany!'); } catch(e){ console.error(e); alert('❌ Nie udało się skopiować.'); } };
                      if (btnExport) btnExport.onclick = ()=>{ const briefIdSafe = (briefId || 'scaffold').toString().slice(0,36); downloadJSON(data, `${briefIdSafe}-scaffold.json`); };
                    })();
                })();
            } else if (state === 'error') {
                titleElement.textContent = '❌ BŁĄD GENEROWANIA SCAFFOLDA';
                body.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#dc3545;">
                        <div style="font-size:48px; margin-bottom:20px;">❌</div>
                        <h3>Wystąpił błąd podczas generowania scaffolda</h3>
                        <div style="background:#f8d7da; border-radius:6px; padding:15px; margin:20px 0; font-size:14px;">
                            <strong>Błąd:</strong> ${meta?.error || 'Nieznany błąd'}
                        </div>
                        <button onclick="closeScaffoldModal()" style="background:#6c757d; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">
                            Zamknij
                        </button>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }

        function toggleScaffoldView() {
            const technicalView = document.getElementById('scaffold-technical-view');
            const simplifiedView = document.getElementById('scaffold-simplified-view');
            const toggleBtn = document.getElementById('btn-toggle-view');
            
            if (technicalView && simplifiedView && toggleBtn) {
                if (technicalView.style.display === 'none') {
                    // Przełącz na widok techniczny
                    technicalView.style.display = 'block';
                    simplifiedView.style.display = 'none';
                    toggleBtn.textContent = '📋 Widok uproszczony';
                    toggleBtn.style.background = '#28a745';
                } else {
                    // Przełącz na widok uproszczony
                    technicalView.style.display = 'none';
                    simplifiedView.style.display = 'block';
                    toggleBtn.textContent = '🔧 Widok techniczny';
                    toggleBtn.style.background = '#007bff';
                }
            }
        }

        function closeScaffoldModal() {
            const modal = document.getElementById('scaffold-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function renderScaffoldDetails(scaffoldData, meta) {
            if (!scaffoldData) return '<div style="color:red;">Brak danych scaffolda</div>';
            
            const scaffoldMeta = scaffoldData.scaffold_meta || {};
            // Compat + defensywa typów
            const sectionsRaw = scaffoldData.content_sections || scaffoldData.sections || [];
            const contentSections = Array.isArray(sectionsRaw) ? sectionsRaw : [];
            const faqStrategy = Array.isArray(scaffoldData.faq_integration_strategy) ? scaffoldData.faq_integration_strategy : (Array.isArray(scaffoldData.faq) ? scaffoldData.faq : []);
            const ctaStrategy = Array.isArray(scaffoldData.cta_placement_strategy) ? scaffoldData.cta_placement_strategy : (Array.isArray(scaffoldData.cta) ? scaffoldData.cta : []);
            const contentDiff = scaffoldData.content_differentiation || scaffoldData.differentiation || {};
            const audienceProfile = (scaffoldMeta && typeof scaffoldMeta === 'object') ? scaffoldMeta.audience_profile || {} : {};
            const demographicBasis = (scaffoldMeta && typeof scaffoldMeta === 'object') ? scaffoldMeta.demographic_basis || '' : '';
            
            return `
                <div style="font-family: Arial, sans-serif; line-height: 1.6;">
                    <!-- Scaffold Meta Info -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:25px;">
                        <div style="background:#f8f9fa; padding:12px; border-radius:6px; text-align:center; border:1px solid #dee2e6;">
                            <div style="font-size:12px; color:#666; margin-bottom:4px; font-weight:600;">FUNNEL STAGE</div>
                            <div style="font-size:16px; font-weight:600; color:#8e44ad; text-transform:uppercase;">${scaffoldMeta.funnel_stage || 'awareness'}</div>
                        </div>
                        <div style="background:#f8f9fa; padding:12px; border-radius:6px; text-align:center; border:1px solid #dee2e6;">
                            <div style="font-size:12px; color:#666; margin-bottom:4px; font-weight:600;">WORD COUNT</div>
                            <div style="font-size:16px; font-weight:600; color:#28a745;">${scaffoldMeta.target_word_count || 2000}</div>
                        </div>
                        <div style="background:#f8f9fa; padding:12px; border-radius:6px; text-align:center; border:1px solid #dee2e6;">
                            <div style="font-size:12px; color:#666; margin-bottom:4px; font-weight:600;">SECTIONS</div>
                            <div style="font-size:16px; font-weight:600; color:#e67e22;">${contentSections.length}</div>
                        </div>
                        <div style="background:#f8f9fa; padding:12px; border-radius:6px; text-align:center; border:1px solid #dee2e6;">
                            <div style="font-size:12px; color:#666; margin-bottom:4px; font-weight:600;">PSYCHOLOGY</div>
                            <div style="font-size:16px; font-weight:600; color:#8e44ad;">${meta?.psychology_applied?.length || 0} triggers</div>
                        </div>
                    </div>
                    
                    <!-- Content Sections Preview -->
                    <div style="margin-bottom:25px;">
                        <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">📋 Content Sections (${contentSections.length})</h4>
                        <div id="scaffold-outline" style="max-height:500px; overflow-y:auto; background:white; border:1px solid #ddd; border-radius:6px; padding:15px;">
                            ${contentSections.map((section, index) => `
                                <div style="margin-bottom:15px; padding:12px; background:#f8f9fa; border-radius:6px; border-left:4px solid #e67e22;">
                                    <div style="font-weight:bold; color:#333; margin-bottom:8px;">
                                        ${index + 1}. ${section.h2 || 'Untitled Section'}
                                    </div>
                                    ${Array.isArray(section.section_kpis) && section.section_kpis.length ? `
                                      <div style="margin-bottom:6px;">
                                        ${section.section_kpis.map(k=>`<span style='display:inline-block; padding:2px 8px; border-radius:10px; background:#eef6ff; color:#1a73e8; font-size:11px; margin:2px;'>${k}</span>`).join('')}
                                      </div>` : ''}
                                    ${section.expected_user_action ? `
                                      <div style="font-size:12px; color:#555; margin-bottom:6px;">
                                        <strong>Expected action:</strong> ${section.expected_user_action}
                                      </div>` : ''}
                                    ${section.why_it_matters ? `<div style="font-size:12px; color:#2e7d32; margin-bottom:6px;"><strong>Why it matters:</strong> ${section.why_it_matters}</div>` : ''}
                                    ${section.next_step ? `<div style="font-size:12px; color:#1565c0; margin-bottom:8px;"><strong>Next step:</strong> ${section.next_step}</div>` : ''}
                                    <div style="font-size:13px; color:#666; margin-bottom:8px;">
                                        <strong>Objectives:</strong> ${(section.section_objectives || []).slice(0, 2).join(', ')}
                                    </div>
                                    ${typeof section.section_readiness_score === 'number' ? `
                                        <div style="height:8px; background:#e9ecef; border-radius:4px; margin-bottom:8px;">
                                            <div style="width:${Math.round(section.section_readiness_score*100)}%; height:8px; background:#28a745; border-radius:4px;"></div>
                                        </div>
                                    ` : ''}
                                    ${typeof section.section_readiness_score === 'number' ? `
                                        <div style="font-size:12px; color:#155724; background:#d4edda; border-left:4px solid #28a745; padding:6px; border-radius:4px; margin-bottom:6px;">
                                            ✅ <strong>Section readiness:</strong> ${(section.section_readiness_score*100).toFixed(0)}%
                                        </div>
                                    ` : ''}
                                    ${section.intro_snippet ? `
                                        <div style="font-size:12px; color:#333; background:#fff; border:1px dashed #ddd; padding:8px; border-radius:4px; margin-bottom:6px;">
                                            <strong>Intro:</strong> ${section.intro_snippet}
                                        </div>
                                    ` : ''}
                                    ${(section.key_ideas && section.key_ideas.length) ? `
                                        <div style="font-size:12px; color:#333; background:#fff; border:1px solid #eee; padding:8px; border-radius:4px; margin-bottom:6px;">
                                            <strong>Key ideas:</strong>
                                            <ul style="margin:6px 0 0 18px;">
                                                ${section.key_ideas.slice(0,4).map(ki => `<li>${ki.idea}${ki.proof_required ? ` <em style='color:#6c757d'>(dowód: ${ki.proof_required})</em>` : ''}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${(section.questions_to_answer && section.questions_to_answer.length) ? `
                                        <div style="font-size:12px; color:#333; background:#fff; border:1px solid #eee; padding:8px; border-radius:4px; margin-bottom:6px;">
                                            <strong>Questions to answer:</strong>
                                            <ul style="margin:6px 0 0 18px;">
                                                ${section.questions_to_answer.slice(0,5).map(q => `<li>${q}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${(section.data_points && section.data_points.length) ? `
                                        <div style="font-size:12px; color:#333; background:#fff; border:1px solid #eee; padding:8px; border-radius:4px; margin-bottom:6px;">
                                            <strong>Data points:</strong>
                                            <ul style="margin:6px 0 0 18px;">
                                                ${section.data_points.slice(0,5).map(dp => `<li>${dp.label || dp}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${section.suggested_sources && section.suggested_sources.length ? `
                                        <div style="font-size:12px; color:#333; background:#fff; border:1px solid #eee; padding:8px; border-radius:4px; margin-bottom:6px;">
                                            <strong>Suggested sources:</strong> ${section.suggested_sources.slice(0,5).join(', ')}
                                        </div>
                                    ` : ''}
                                    ${section.keywords_focus ? `
                                        <div style="font-size:12px; color:#333; background:#fff; border:1px solid #eee; padding:8px; border-radius:4px; margin-bottom:6px;">
                                            <strong>Keywords:</strong>
                                            ${Array.isArray(section.keywords_focus.primary) ? section.keywords_focus.primary.map(k=>`<span style='display:inline-block; padding:2px 8px; border-radius:8px; background:#e74c3c; color:white; font-size:11px; margin:2px;'>${k}</span>`).join('') : ''}
                                            ${Array.isArray(section.keywords_focus.semantic) ? section.keywords_focus.semantic.map(k=>`<span style='display:inline-block; padding:2px 8px; border-radius:8px; background:#3498db; color:white; font-size:11px; margin:2px;'>${k}</span>`).join('') : ''}
                                        </div>
                                    ` : ''}
                                    ${section.psychology_integration ? `
                                        <div style="font-size:12px; color:#8e44ad; background:#f3e5f5; padding:6px; border-radius:4px;">
                                            🧠 <strong>Psychology:</strong> ${section.psychology_integration.primary_trigger} - ${section.psychology_integration.emotional_angle}
                                        </div>
                                    ` : ''}
                                    ${Array.isArray(section.subsections) && section.subsections.length ? `
                                      <div style='margin-top:10px; padding:10px; background:#fff; border:1px solid #eee; border-radius:6px;'>
                                        ${section.subsections.map((ss, sidx)=>`
                                          <div style='margin-bottom:10px; padding:8px; background:#fafafa; border-left:3px solid #03a9f4;'>
                                            <div style='font-weight:bold; color:#03a9f4; margin-bottom:6px;'>${index + 1}.${sidx + 1} ${ss.h3 || ''}</div>
                                            ${Array.isArray(ss.bullet_points) && ss.bullet_points.length ? `
                                              <ol style='margin:6px 0 8px 18px;'>
                                                ${ss.bullet_points.map(bp=>`<li style='font-size:12px; color:#333;'>${bp}</li>`).join('')}
                                              </ol>` : ''}
                                            ${Array.isArray(ss.entities_checklist) && ss.entities_checklist.length ? `
                                              <div style='margin:4px 0;'>
                                                <strong style='font-size:12px;'>Entities:</strong>
                                                ${ss.entities_checklist.map(et=>`<span style='display:inline-block; padding:2px 6px; margin:2px; background:#e8f5e8; color:#155724; border-radius:8px; font-size:11px;'>${et}</span>`).join('')}
                                              </div>` : ''}
                                            ${Array.isArray(ss.data_citations_required) && ss.data_citations_required.length ? `
                                              <div style='margin:4px 0;'>
                                                <strong style='font-size:12px;'>Wymaga źródeł:</strong>
                                                ${ss.data_citations_required.map(dc=>`<span style='display:inline-block; padding:2px 6px; margin:2px; background:#fff3cd; color:#856404; border-radius:8px; font-size:11px;'>${dc}</span>`).join('')}
                                              </div>` : ''}
                                            ${Array.isArray(ss.examples_to_include) && ss.examples_to_include.length ? `
                                              <div style='margin:4px 0;'>
                                                <strong style='font-size:12px;'>Przykłady:</strong>
                                                <div style='font-size:12px; color:#555;'>${ss.examples_to_include.join('; ')}</div>
                                              </div>` : ''}
                                          </div>
                                        `).join('')}
                                      </div>
                                    ` : ''}
                                    ${section.strategic_linking && section.strategic_linking.length > 0 ? `
                                        <div style="font-size:12px; color:#17a2b8; margin-top:6px;">
                                            🔗 <strong>Strategic Links:</strong> ${section.strategic_linking.length} linków z psychology reasoning
                                            <div style="margin-top:6px; background:#fff; border:1px solid #eee; border-radius:4px; padding:8px;">
                                                ${section.strategic_linking.slice(0,3).map(l => `
                                                    <div style='margin-bottom:6px;'>
                                                        <div style='font-weight:bold;'>${l.anchor || '(no anchor)'} → <span style='font-family:monospace;'>${l.url || '#'}</span></div>
                                                        <div style='color:#666;'>
                                                            📍 <strong>Section:</strong> ${l.placement_section || 'current'} | 🧩 <strong>Exact:</strong> ${l.exact_placement || l.placement || '-'}
                                                            ${l.psychology_reasoning ? `<br/>🧠 ${l.psychology_reasoning}` : ''}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Audience Lens -->
                    <div style="margin-bottom:20px;">
                      <h4 style="color:#2c3e50; margin-bottom:10px;">🧭 Audience Lens</h4>
                      <div style="background:#f8f9fa; border:1px solid #ddd; border-radius:6px; padding:12px;">
                        <div style="display:flex; gap:15px; flex-wrap:wrap;">
                          <div><strong>Persona:</strong> ${audienceProfile.persona_label || 'general'}</div>
                          <div><strong>Płeć:</strong> ${audienceProfile.dominant_gender || 'mixed'}</div>
                          <div><strong>Wiek:</strong> ${(Array.isArray(audienceProfile.top_age_brackets)?audienceProfile.top_age_brackets:[]).join(', ') || '-'}</div>
                          <div><strong>Regiony:</strong> ${(Array.isArray(audienceProfile.top_regions)?audienceProfile.top_regions:[]).join(', ') || '-'}</div>
                        </div>
                        ${Array.isArray(audienceProfile.voice_tips) && audienceProfile.voice_tips.length ? `
                          <div style='margin-top:8px;'>
                            <strong>Voice tips:</strong>
                            ${audienceProfile.voice_tips.map(t=>`<span style='display:inline-block; padding:2px 6px; margin:2px; background:#eef6ff; color:#1a73e8; border-radius:8px; font-size:11px;'>${t}</span>`).join('')}
                          </div>`: ''}
                        <div style='margin-top:8px; font-size:11px; color:#666;'>
                          <span title='${demographicBasis || ''}'>ℹ️ Źródło: demographic basis</span>
                          <button id='btn-highlight-lens' style='margin-left:8px; padding:4px 8px; font-size:12px;'>✨ Highlight lens</button>
                        </div>
                      </div>
                    </div>
                    
                    ${scaffoldData.writer_guidance ? `
                        <div style="margin-bottom:25px;">
                            <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">🧭 Writer Guidance</h4>
                            <div style="background:white; border:1px solid #ddd; border-radius:6px; padding:15px;">
                                ${scaffoldData.writer_guidance.executive_summary ? `<div style='margin-bottom:10px;'><strong>Executive summary:</strong> ${scaffoldData.writer_guidance.executive_summary}</div>` : ''}
                                ${Array.isArray(scaffoldData.writer_guidance.content_plan) ? `<div style='margin-bottom:10px;'><strong>Plan treści:</strong><ul style='margin:6px 0 0 18px;'>${scaffoldData.writer_guidance.content_plan.map(s=>`<li>${s}</li>`).join('')}</ul></div>` : ''}
                                ${scaffoldData.writer_guidance.checklists ? `
                                    <div style='display:grid; grid-template-columns:1fr 1fr; gap:10px;'>
                                        <div>
                                            <div style='font-weight:bold; margin-bottom:6px;'>SEO checklist</div>
                                            <ul style='margin:6px 0 0 18px;'>${(scaffoldData.writer_guidance.checklists.seo||[]).map(i=>`<li>${i}</li>`).join('')}</ul>
                                        </div>
                                        <div>
                                            <div style='font-weight:bold; margin-bottom:6px;'>UX checklist</div>
                                            <ul style='margin:6px 0 0 18px;'>${(scaffoldData.writer_guidance.checklists.ux||[]).map(i=>`<li>${i}</li>`).join('')}</ul>
                                        </div>
                                    </div>
                                ` : ''}
                                ${Array.isArray(scaffoldData.writer_guidance.risks) ? `<div style='margin-top:10px;'><strong>Ryzyka:</strong> ${scaffoldData.writer_guidance.risks.join(', ')}</div>` : ''}
                                ${Array.isArray(scaffoldData.writer_guidance.success_metrics) ? `<div style='margin-top:10px;'><strong>Metryki sukcesu:</strong> ${scaffoldData.writer_guidance.success_metrics.join(', ')}</div>` : ''}
                                ${scaffoldData.writer_guidance.tone_notes ? `<div style='margin-top:10px;'><strong>Tone notes:</strong> ${scaffoldData.writer_guidance.tone_notes}</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- FAQ Integration Strategy -->
                    ${faqStrategy.length > 0 ? `
                        <div style="margin-bottom:25px;">
                            <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">❓ FAQ Integration Strategy (${faqStrategy.length})</h4>
                            <div style="background:white; border:1px solid #ddd; border-radius:6px; padding:15px; max-height:200px; overflow-y:auto;">
                                ${faqStrategy.map(faq => `
                                    <div style="margin-bottom:10px; padding:8px; background:#e8f5e8; border-radius:4px; border-left:3px solid #28a745;">
                                        <div style="font-weight:bold; font-size:13px; margin-bottom:4px;">${faq.question}</div>
                                        <div style="font-size:11px; color:#666;">
                                            📍 <strong>Target:</strong> ${faq.target_section} | 
                                            📝 <strong>Method:</strong> ${faq.integration_method} |
                                            🧠 <strong>Psychology:</strong> ${faq.psychology_approach}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- CTA Placement Strategy -->
                    ${Array.isArray(ctaStrategy) && ctaStrategy.length > 0 ? `
                        <div style="margin-bottom:25px;">
                            <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">📞 CTA Placement Strategy (${ctaStrategy.length})</h4>
                            <div style="background:white; border:1px solid #ddd; border-radius:6px; padding:15px;">
                                ${ctaStrategy.filter(cta => cta && typeof cta === 'object').map(cta => `
                                    <div style="margin-bottom:10px; padding:8px; background:#e1f5fe; border-radius:4px; border-left:3px solid #03a9f4;">
                                        <div style="font-weight:bold; font-size:13px; margin-bottom:4px;">"${cta.cta_text || cta.text || ''}"</div>
                                        <div style="font-size:11px; color:#666;">
                                            📍 <strong>Section:</strong> ${cta.placement_section || cta.placement || '-'} | 
                                            🎯 <strong>Psychology:</strong> ${cta.psychology_optimization || '-'} |
                                            💡 <strong>Reasoning:</strong> ${cta.conversion_reasoning || cta.reasoning || '-'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Media Plan -->
                    ${scaffoldData.media_plan && scaffoldData.media_plan.length > 0 ? `
                        <div style="margin-bottom:25px;">
                            <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">🎬 Media Plan (${scaffoldData.media_plan.length} elements)</h4>
                            <div style="background:white; border:1px solid #ddd; border-radius:6px; padding:15px;">
                                ${scaffoldData.media_plan.map((media, index) => `
                                    <div style="margin-bottom:12px; padding:10px; background:#f8f9fa; border-radius:4px; border-left:3px solid #17a2b8;">
                                        <div style="font-weight:bold; font-size:13px; margin-bottom:6px; color:#333;">
                                            ${index + 1}. ${media.type?.toUpperCase() || 'MEDIA'} - ${media.content_description || 'No description'}
                                        </div>
                                        <div style="font-size:11px; color:#666; margin-bottom:4px;">
                                            📍 <strong>Placement:</strong> ${media.placement || 'Not specified'} | 
                                            📏 <strong>Specs:</strong> ${media.specifications || media.dimensions || 'Default'}
                                        </div>
                                        ${media.alt_text ? `
                                            <div style="font-size:11px; color:#28a745; margin-bottom:2px;">
                                                🏷️ <strong>Alt text:</strong> "${media.alt_text}"
                                            </div>
                                        ` : ''}
                                        ${media.caption ? `
                                            <div style="font-size:11px; color:#6c757d;">
                                                💬 <strong>Caption:</strong> "${media.caption}"
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- TODO Gaps -->
                    ${scaffoldData.todo_gaps && scaffoldData.todo_gaps.length > 0 ? `
                        <div style="margin-bottom:25px;">
                            <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">📝 TODO Gaps (${scaffoldData.todo_gaps.length} items)</h4>
                            <div style="background:white; border:1px solid #ddd; border-radius:6px; padding:15px;">
                                ${scaffoldData.todo_gaps.map((todo, index) => `
                                    <div style="margin-bottom:10px; padding:8px; background:#fff3cd; border-radius:4px; border-left:3px solid #ffc107;">
                                        <div style="font-weight:bold; font-size:13px; margin-bottom:4px; color:#856404;">
                                            ${index + 1}. ${todo.description || todo}
                                        </div>
                                        ${todo.priority ? `
                                            <div style="font-size:11px; color:#666; margin-bottom:2px;">
                                                🔥 <strong>Priority:</strong> ${todo.priority} | 
                                                🕒 <strong>Deadline:</strong> ${todo.deadline || 'Before publication'}
                                            </div>
                                        ` : ''}
                                        ${todo.research_hint ? `
                                            <div style="font-size:11px; color:#6c757d;">
                                                💡 <strong>Research hint:</strong> ${todo.research_hint}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                <div style="background:#d1ecf1; border-left:4px solid #17a2b8; padding:10px; border-radius:4px; margin-top:10px; font-size:12px; color:#0c5460;">
                                    <strong>📋 Writer Instructions:</strong> Complete all TODO items before content creation. Research and verify all data points for accuracy.
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Link Planner -->
                    ${(function(){
                        // Zbierz wszystkie linki
                        const links = [];
                        contentSections.forEach(sec=>{
                          const arr = Array.isArray(sec.strategic_linking) ? sec.strategic_linking : [];
                          arr.forEach(l=>{
                            links.push({
                              from_h2: l.from_h2 || sec.h2 || '-',
                              from_h3: l.from_h3 || '',
                              anchor: l.anchor || '-',
                              url: l.url || '-',
                              type: l.type || '-',
                              placement_section: l.placement_section || '-',
                              exact_placement: l.exact_placement || '-',
                              stage: l.funnel_stage || '-',
                              priority: typeof l.priority==='number'? l.priority : '-',
                              confidence: typeof l.confidence==='number'? l.confidence : '-',
                              reasoning: l.psychology_reasoning || ''
                            });
                          })
                        });
                        if (!links.length) return '';
                        let html = `
                        <div style="margin-bottom:25px;">
                          <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">🔗 Link Planner (${links.length})</h4>
                          <div style='overflow-x:auto;'>
                          <table style='width:100%; border-collapse:collapse; font-size:12px; background:white;'>
                            <thead>
                              <tr style='background:#f5f5f5;'>
                                <th style='padding:6px; border:1px solid #ddd;'>From (H2/H3)</th>
                                <th style='padding:6px; border:1px solid #ddd;'>Anchor</th>
                                <th style='padding:6px; border:1px solid #ddd;'>To (URL)</th>
                                <th style='padding:6px; border:1px solid #ddd;'>Type</th>
                                <th style='padding:6px; border:1px solid #ddd;'>Placement</th>
                                <th style='padding:6px; border:1px solid #ddd;'>Stage</th>
                                <th style='padding:6px; border:1px solid #ddd;'>Priority</th>
                                <th style='padding:6px; border:1px solid #ddd;'>Confidence</th>
                                <th style='padding:6px; border:1px solid #ddd;'>Reasoning</th>
                              </tr>
                            </thead>
                            <tbody>
                              ${links.map(l=>`
                                <tr>
                                  <td style='padding:6px; border:1px solid #ddd;'>${l.from_h2}${l.from_h3? ' / '+l.from_h3 : ''}</td>
                                  <td style='padding:6px; border:1px solid #ddd;'>${l.anchor}</td>
                                  <td style='padding:6px; border:1px solid #ddd; font-family:monospace;'>${l.url}</td>
                                  <td style='padding:6px; border:1px solid #ddd;'>${l.type}</td>
                                  <td style='padding:6px; border:1px solid #ddd;'>${l.placement_section} | ${l.exact_placement}</td>
                                  <td style='padding:6px; border:1px solid #ddd;'>${l.stage}</td>
                                  <td style='padding:6px; border:1px solid #ddd; text-align:right;'>${l.priority}</td>
                                  <td style='padding:6px; border:1px solid #ddd; text-align:right;'>${l.confidence}</td>
                                  <td style='padding:6px; border:1px solid #ddd;'>${l.reasoning}</td>
                                </tr>
                              `).join('')}
                            </tbody>
                          </table>
                          </div>
                          <div style='margin-top:10px; background:#222; color:#eee; border-radius:6px; padding:10px; font-family:monospace; font-size:12px;'>
                            <pre style='margin:0;'>${links.map(l=>{
                              const tag = l.type==='hierarchy'? '[H]' : (l.type==='bridge'? '[B]' : '[F]');
                              return `${tag} ${l.from_h2}${l.from_h3? ' / '+l.from_h3:''} -> ${l.url} (${l.anchor})`;
                            }).join('\n')}</pre>
                          </div>
                        </div>`;
                        return html;
                    })()}
                    
                    <!-- UX Elements -->
                    ${scaffoldData.ux_elements ? `
                        <div style="margin-bottom:25px;">
                            <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">🎨 UX Elements & Navigation</h4>
                            <div style="background:white; border:1px solid #ddd; border-radius:6px; padding:15px;">
                                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px;">
                                    ${scaffoldData.ux_elements.table_of_contents ? `
                                        <div style="background:#e8f5e8; padding:10px; border-radius:4px;">
                                            <div style="font-weight:bold; color:#155724; margin-bottom:5px;">📑 Table of Contents</div>
                                            <div style="font-size:12px; color:#155724;">
                                                ${scaffoldData.ux_elements.toc_sections ? scaffoldData.ux_elements.toc_sections.slice(0, 3).join(' → ') : 'Auto-generated from H2 headings'}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${scaffoldData.ux_elements.breadcrumbs ? `
                                        <div style="background:#e1f5fe; padding:10px; border-radius:4px;">
                                            <div style="font-weight:bold; color:#01579b; margin-bottom:5px;">🍞 Breadcrumbs</div>
                                            <div style="font-size:12px; color:#01579b;">
                                                ${Array.isArray(scaffoldData.ux_elements.breadcrumbs) ? scaffoldData.ux_elements.breadcrumbs.join(' > ') : 'Home > Category > Page'}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${scaffoldData.ux_elements.reading_time_estimate ? `
                                        <div style="background:#f3e5f5; padding:10px; border-radius:4px;">
                                            <div style="font-weight:bold; color:#6a1b99; margin-bottom:5px;">⏱️ Reading Time</div>
                                            <div style="font-size:12px; color:#6a1b99;">
                                                ${scaffoldData.ux_elements.reading_time_estimate}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${scaffoldData.ux_elements.social_sharing ? `
                                        <div style="background:#fff3e0; padding:10px; border-radius:4px;">
                                            <div style="font-weight:bold; color:#e65100; margin-bottom:5px;">📤 Social Sharing</div>
                                            <div style="font-size:12px; color:#e65100;">
                                                ${Array.isArray(scaffoldData.ux_elements.social_sharing) ? scaffoldData.ux_elements.social_sharing.join(', ') : 'Standard sharing buttons'}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${scaffoldData.ux_elements.sidebar_nav && scaffoldData.ux_elements.sidebar_nav.length > 0 ? `
                                    <div style="margin-top:15px; padding:10px; background:#f8f9fa; border-radius:4px;">
                                        <div style="font-weight:bold; color:#333; margin-bottom:8px;">🔗 Sidebar Navigation</div>
                                        <div style="font-size:12px; color:#666;">
                                            ${scaffoldData.ux_elements.sidebar_nav.map(nav => `• ${nav}`).join('<br>')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Content Differentiation -->
                    ${contentDiff.unique_angles && contentDiff.unique_angles.length > 0 ? `
                        <div style="margin-bottom:25px;">
                            <h4 style="color:#e67e22; margin-bottom:15px; font-size:16px;">🎯 Content Differentiation</h4>
                            <div style="background:#fff3e0; border-left:4px solid #ff9800; padding:15px; border-radius:4px;">
                                <div style="margin-bottom:10px;">
                                    <strong>Unique Angles:</strong> ${contentDiff.unique_angles.join(', ')}
                                </div>
                                ${contentDiff.competitive_advantages ? `
                                    <div style="margin-bottom:10px;">
                                        <strong>Competitive Advantages:</strong> ${contentDiff.competitive_advantages.join(', ')}
                                    </div>
                                ` : ''}
                                ${contentDiff.expert_positioning ? `
                                    <div>
                                        <strong>Expert Positioning:</strong> ${contentDiff.expert_positioning}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Meta Information -->
                    <div style="background:#f8f9fa; border-radius:6px; padding:15px; margin-bottom:20px; font-size:12px; color:#666;">
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px;">
                            <div><strong>Context Pack Size:</strong> ${meta?.context_pack_size ? (meta.context_pack_size / 1000).toFixed(1) + 'KB' : 'N/A'}</div>
                            <div><strong>Strategic Links:</strong> ${meta?.strategic_links || 0}</div>
                            <div><strong>Psychology Applied:</strong> ${meta?.psychology_applied?.join(', ') || 'None'}</div>
                            <div><strong>Generated:</strong> ${meta?.generated_at ? new Date(meta.generated_at).toLocaleString() : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="text-align:center; margin-top:25px; padding-top:20px; border-top:1px solid #ddd;">
                        <button onclick="exportScaffold('json', '${scaffoldData.scaffold_meta?.page_id || 'unknown'}')" style="background:#28a745; color:white; border:none; padding:10px 20px; border-radius:4px; margin:0 5px; cursor:pointer; font-size:14px;">
                            📄 Export JSON
                        </button>
                        <button onclick="copyScaffoldToClipboard()" style="background:#17a2b8; color:white; border:none; padding:10px 20px; border-radius:4px; margin:0 5px; cursor:pointer; font-size:14px;">
                            📋 Copy to Clipboard
                        </button>
                        <button onclick="viewFullScaffold()" style="background:#ffc107; color:#333; border:none; padding:10px 20px; border-radius:4px; margin:0 5px; cursor:pointer; font-size:14px;">
                            🔍 View Full Details
                        </button>
                        <button onclick="closeScaffoldModal()" style="background:#6c757d; color:white; border:none; padding:10px 20px; border-radius:4px; margin:0 5px; cursor:pointer; font-size:14px;">
                            ✖️ Close
                        </button>
                    </div>
                </div>
            `;
        }

// ====== NASA MISSION CONTROL — CONTENT SCAFFOLD DESIGNER ======
        function renderSimplifiedScaffold(scaffoldData, meta) {
            if (!scaffoldData) return '<div style="color:red;">Brak danych scaffolda</div>';
            
            const scaffoldMeta = scaffoldData.scaffold_meta || {};
            const contentSections = Array.isArray(scaffoldData.content_sections) ? scaffoldData.content_sections : [];
            const todoGaps = Array.isArray(scaffoldData.todo_gaps) ? scaffoldData.todo_gaps : [];
            
            // Funkcja pomocnicza do renderowania pytań
            function renderQuestions(questions) {
                if (!Array.isArray(questions) || questions.length === 0) return '';
                return `
                    <div class="questions-box">
                        <div class="questions-title">ANSWER THESE QUESTIONS IN THIS SECTION:</div>
                        ${questions.map(q => `<div class="question-item">${q}</div>`).join('')}
                    </div>
                `;
            }
            
            // Funkcja pomocnicza do renderowania linków
            function renderLinks(links) {
                if (!Array.isArray(links) || links.length === 0) return '';
                return `
                    <div class="links-box">
                        <div class="links-title">INTERNAL LINKS TO INCLUDE:</div>
                        ${links.map(link => `
                            <div class="link-item">
                                <div class="link-anchor">${link.anchor || link.anchor_text || 'Link'}</div>
                                <div class="link-url">${link.url || link.target_url || '#'}</div>
                                <div class="link-reason">${link.psychology_reasoning || link.rationale || 'Link strategiczny'}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // NASA MISSION CONTROL CSS
            const nasaCSS = `
                <style>
            .scaffold-nasa-root{--bg:#f7f8fa;--panel:#fff;--panel-2:#f0f2f5;--text:#222;--muted:#6c757d;
              --blue:#0b3d91;--blue-2:#1560bd;--green:#198754;--red:#dc3545;--orange:#fd7e14;--purple:#6f42c1;--cyan:#17a2b8;
              --pink:#e91e63;--teal:#20c997;--indigo:#6610f2;--yellow:#ffc107;--lime:#32cd32;
              --border:#e5e7eb;--shadow:0 2px 8px rgba(0,0,0,.06);--gap:10px;--pad:12px;--radius:8px}
            .scaffold-nasa-root *{box-sizing:border-box}
            .scaffold-nasa-root{font:12px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;color:var(--text)}
            .content-meta{background:#fff;border:2px solid var(--blue);padding:16px;margin-bottom:20px;border-radius:6px}
            .meta-title{font-size:14px;font-weight:800;color:var(--blue);margin-bottom:8px}
            .meta-desc{font-size:11px;color:var(--text);margin-bottom:12px}
            .meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
            .meta-item{background:var(--panel-2);padding:10px;border-left:3px solid var(--blue);border-radius:4px}
            .meta-label{font-size:9px;color:var(--muted);font-weight:800;text-transform:uppercase;margin-bottom:4px;letter-spacing:.5px}
            .meta-value{font-size:11px;font-weight:600;color:var(--text)}
            .warning-box{background:#fff;border:2px solid var(--red);border-left:6px solid var(--red);
              padding:16px;margin:20px 0;border-radius:6px}
            .warning-title{font-size:11px;font-weight:800;color:var(--red);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
            .warning-list{margin:0;padding-left:20px}
            .warning-list li{font-size:11px;color:var(--text);margin-bottom:8px;line-height:1.6}
            .h1-section{background:#fff;border:2px solid var(--blue);padding:16px;border-radius:6px;margin:20px 0}
            .h1-title{font-size:18px;font-weight:800;color:var(--blue);margin-bottom:12px}
            .h1-intro-label{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;
              letter-spacing:.5px;margin-bottom:6px}
            .h1-intro{background:var(--panel-2);padding:12px;border-radius:4px;font-size:11px;
              line-height:1.6;border:1px solid var(--border);color:var(--text)}
            .h2-section{background:#fff;border:1px solid var(--border);border-left:4px solid var(--blue);
              padding:16px;margin:16px 0;border-radius:4px}
            .h2-header{margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
            .h2-title{font-size:16px;font-weight:800;color:var(--blue)}
            .word-count{font-size:14px;font-weight:700;color:var(--muted);
              font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Courier New",monospace}
            .h2-intro-label{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;
              letter-spacing:.5px;margin:12px 0 6px 0}
            .h2-intro{background:var(--panel-2);padding:12px;border-radius:4px;border:1px solid var(--border);
              font-size:11px;line-height:1.6;color:var(--text);margin-bottom:12px}
            .h3-subsection{background:#fff;border-left:3px solid var(--cyan);padding:12px;
              margin:12px 0 12px 20px;border-radius:4px}
            .h3-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:8px}
            .h3-instructions-label{font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;
              letter-spacing:.5px;margin-bottom:6px}
            .h3-instructions{font-size:11px;color:var(--text);line-height:1.6;background:var(--panel-2);
              padding:10px;border-radius:4px;border:1px solid var(--border)}
            .questions-box{background:#fff;border:2px solid var(--orange);padding:14px;margin:16px 0;border-radius:6px}
            .questions-title{font-size:10px;font-weight:800;color:var(--orange);margin-bottom:10px;
              text-transform:uppercase;letter-spacing:.5px}
            .question-item{background:var(--panel-2);border-left:3px solid var(--orange);padding:10px 12px;
              margin-bottom:8px;font-size:11px;color:var(--text);line-height:1.5;border-radius:4px}
            .links-box{background:#fff;border:2px solid var(--cyan);padding:14px;margin:16px 0;border-radius:6px}
            .links-title{font-size:10px;font-weight:800;color:var(--cyan);margin-bottom:10px;
              text-transform:uppercase;letter-spacing:.5px}
            .link-item{background:var(--panel-2);border-left:3px solid var(--cyan);padding:10px 12px;
              margin-bottom:10px;border-radius:4px}
            .link-anchor{font-size:11px;font-weight:700;color:var(--text);margin-bottom:4px}
            .link-anchor::before{content:'📎 ';font-size:12px}
            .link-url{font-size:10px;color:var(--cyan);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Courier New",monospace;
              word-break:break-all;margin-bottom:6px}
            .link-reason{font-size:10px;color:var(--muted);line-height:1.5}
            .final-summary{background:#fff;border:2px solid var(--yellow);padding:16px;margin:20px 0;border-radius:6px}
            .summary-title{font-size:12px;font-weight:800;color:#856404;margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
            .summary-list{margin:0;padding-left:20px}
            .summary-list li{font-size:11px;color:var(--text);margin-bottom:8px;line-height:1.6;font-weight:500}
            @media (max-width:768px){
              .meta-grid{grid-template-columns:1fr}
              .h2-header{flex-direction:column;align-items:flex-start;gap:8px}
            }
                </style>
            `;
            
            // GŁÓWNY HTML - NASA MISSION CONTROL STYLE
            return nasaCSS + `
            <div class="scaffold-nasa-root">
                
                <!-- Content Meta Information -->
                <div class="content-meta">
                    <div class="meta-title">📋 Content Information</div>
                    <p class="meta-desc">
                        Complete writer's guide with detailed structure
                    </p>
                    
                    <div class="meta-grid">
                        <div class="meta-item">
                            <div class="meta-label">Topic (H1)</div>
                            <div class="meta-value">${scaffoldMeta.title_h1 || 'Article'}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Target Length</div>
                            <div class="meta-value">${scaffoldMeta.target_word_count || 2000} words</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Keywords</div>
                            <div class="meta-value">${Array.isArray(scaffoldMeta.primary_keywords) ? scaffoldMeta.primary_keywords.join(', ') : 'brak danych'}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Target Audience</div>
                            <div class="meta-value">${scaffoldMeta.target_audience || 'Users researching before decision'}</div>
                        </div>
                        </div>
                    </div>
                    
                <!-- Warning Box - Data Verification -->
                    ${todoGaps.length > 0 ? `
                <div class="warning-box">
                    <div class="warning-title">⚠️ VERIFY BEFORE WRITING:</div>
                    <ul class="warning-list">
                        ${todoGaps.slice(0, 8).map(gap => {
                            const gapText = gap.gap || gap.research_needed || gap;
                            return `<li>${gapText}</li>`;
                        }).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <!-- H1 Section -->
                <div class="h1-section">
                    <h1 class="h1-title">H1: ${scaffoldMeta.title_h1 || 'Tytuł artykułu'}</h1>
                    <div class="h1-intro-label">INTRODUCTION PARAGRAPH (50–80 words)</div>
                    <div class="h1-intro">
                        Napisz wprowadzenie, które: • Przedstawia najważniejsze korzyści tematu
                        • Wspomina główne słowa kluczowe naturalnie w kontekście
                        • Zapowiada co czytelnik znajdzie w artykule
                        • Używa jasnego i przystępnego języka
                        </div>
                    </div>
                    
                <!-- Content Sections (H2/H3) -->
                    ${contentSections.map((section, index) => `
                    <div class="h2-section">
                        <div class="h2-header">
                            <h2 class="h2-title">H2: ${section.h2 || 'Untitled Section'}</h2>
                                <span class="word-count">${section.target_word_count || 400} words</span>
                            </div>
                        
                        <div class="h2-intro-label">OPENING PARAGRAPH (80–100 words)</div>
                        <div class="h2-intro">
                            ${section.intro_snippet || 'Napisz paragraf wprowadzający, który: • Definiuje temat sekcji • Wyjaśnia dlaczego ten temat jest ważny dla czytelnika • Zapowiada co zostanie omówione w podsekcjach'}
                                </div>
                                
                                <!-- H3 Subsections -->
                                ${Array.isArray(section.subsections) ? section.subsections.map((subsection, subIndex) => `
                            <div class="h3-subsection">
                                <h3 class="h3-title">H3: ${subsection.h3 || 'Podsekcja'}</h3>
                                            ${subsection.builder_instructions ? `
                                    <div class="h3-instructions-label">WRITER INSTRUCTIONS</div>
                                    <div class="h3-instructions">
                                                        ${subsection.builder_instructions}
                                                </div>
                                            ` : ''}
                                    </div>
                                `).join('') : ''}
                                
                                ${renderQuestions(section.questions_to_answer)}
                                ${renderLinks(section.strategic_linking)}
                        </div>
                    `).join('')}
                    
                <!-- Final Summary -->
                <div class="final-summary">
                    <div class="summary-title">⚠️ REMEMBER BEFORE PUBLISHING:</div>
                    <ul class="summary-list">
                        <li>Sprawdź wszystkie ceny i dane techniczne w oficjalnych źródłach</li>
                        <li>Zweryfikuj parametry - muszą być aktualne na dzień publikacji</li>
                        <li>Upewnij się, że wszystkie linki wewnętrzne działają poprawnie</li>
                        <li>Użyj słów kluczowych naturalnie - nie przesadzaj z gęstością</li>
                        <li>Sprawdź czy odpowiedziałeś na wszystkie pytania oznaczone w sekcjach</li>
                        <li>Upewnij się, że artykuł ma minimalną długość ${scaffoldMeta.target_word_count || 2000} words</li>
                        </ul>
                    </div>

                </div>
            `;
        }
        
        // Dodaj funkcję kopiowania scaffolda
        function copyScaffoldContent() {
            const scaffoldContent = document.getElementById('scaffold-simplified-view');
            if (scaffoldContent) {
                const textContent = scaffoldContent.innerText || scaffoldContent.textContent;
                navigator.clipboard.writeText(textContent).then(() => {
                    if (window.showMessage) window.showMessage('Plan treści skopiowany do schowka!', 'success');
                }).catch(err => {
                    console.error('Error copying scaffold content:', err);
                    if (window.showMessage) window.showMessage('Błąd kopiowania planu treści', 'error');
                });
            } else {
                if (window.showMessage) window.showMessage('Brak planu treści do skopiowania', 'error');
            }
        }
        
        // Usuń niepotrzebne funkcje związane z przełączaniem widoków
        
        // Usunięto funkcje renderWriterTemplate i toggleScaffoldView - nie są już potrzebne
        // Pozostawiono tylko copyScaffoldContent dla nowego uproszczonego widoku
    </script>

    <!-- Content Brief Modal -->
    <div id="content-brief-modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
        <div style="background:white; margin:15px; padding:20px; border-radius:8px; width:90%; max-width:1200px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #ddd; padding-bottom:10px;">
                <h2 style="margin:0; color:#333;">Content Brief Details</h2>
                <button onclick="closeContentBriefModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div id="content-brief-modal-body">Loading...</div>
        </div>
    </div>

</body>
</html>
